(function(){define("models/chat_user",["underscore","tibbr"],function(e,t){return t.Model.extend({baseName:"users",initialize:function(){e.bindAll(this,"domain","jid","jid_id","showUrl","image"),this.set("jid",this.jid())},hasWindow:!1,image:function(){return this.asset(this.get("image"))},domain:function(){return t.appConfig("chat","domain")},jid:function(){return this.get("login")+"@"+this.domain()},jid_id:function(){return this.get("login").replace(/\./g,"-")+"-"+this.domain()},showUrl:function(){return this._url("users/"+this.id+"/profile")}})}),define("collections/chat_users",["tibbr","models/chat_user"],function(e,t){return e.Collection.extend({className:"chat_users",model:t,tibbrURL:{controller:"chat",action:"users"},parse:function(e){return e}})}),define("require/strophe",["require/base64","require/md5"],function(e,t){return Function.prototype.bind||(Function.prototype.bind=function(e){var t=this,n=Array.prototype.slice,r=Array.prototype.concat,i=n.call(arguments,1);return function(){return t.apply(e?e:this,r.call(i,n.call(arguments,0)))}}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=Number(arguments[1])||0;n=n<0?Math.ceil(n):Math.floor(n),n<0&&(n+=t);for(;n<t;n++)if(n in this&&this[n]===e)return n;return-1}),function(n){function i(e,t){return new r.Builder(e,t)}function s(e){return new r.Builder("message",e)}function o(e){return new r.Builder("iq",e)}function u(e){return new r.Builder("presence",e)}var r;return r={VERSION:"1.0.2",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas"},addNamespace:function(e,t){r.NS[e]=t},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,forEachChild:function(e,t,n){var i,s;for(i=0;i<e.childNodes.length;i++)s=e.childNodes[i],s.nodeType==r.ElementType.NORMAL&&(!t||this.isTagEqual(s,t))&&n(s)},isTagEqual:function(e,t){return e.tagName.toLowerCase()==t.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var e;return document.implementation.createDocument===undefined?(e=this._getIEXmlDom(),e.appendChild(e.createElement("strophe"))):e=document.implementation.createDocument("jabber:client","strophe",null),e},xmlGenerator:function(){return r._xmlGenerator||(r._xmlGenerator=r._makeGenerator()),r._xmlGenerator},_getIEXmlDom:function(){var e=null,t=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];for(var n=0;n<t.length;n++){if(e!==null)break;try{e=new ActiveXObject(t[n])}catch(r){e=null}}return e},xmlElement:function(e){if(!e)return null;var t=r.xmlGenerator().createElement(e),n,i,s;for(n=1;n<arguments.length;n++){if(!arguments[n])continue;if(typeof arguments[n]=="string"||typeof arguments[n]=="number")t.appendChild(r.xmlTextNode(arguments[n]));else if(typeof arguments[n]=="object"&&typeof arguments[n].sort=="function")for(i=0;i<arguments[n].length;i++)typeof arguments[n][i]=="object"&&typeof arguments[n][i].sort=="function"&&t.setAttribute(arguments[n][i][0],arguments[n][i][1]);else if(typeof arguments[n]=="object")for(s in arguments[n])arguments[n].hasOwnProperty(s)&&t.setAttribute(s,arguments[n][s])}return t},xmlescape:function(e){return e=e.replace(/\&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/'/g,"&apos;"),e=e.replace(/"/g,"&quot;"),e},xmlTextNode:function(e){return e=r.xmlescape(e),r.xmlGenerator().createTextNode(e)},getText:function(e){if(!e)return null;var t="";e.childNodes.length===0&&e.nodeType==r.ElementType.TEXT&&(t+=e.nodeValue);for(var n=0;n<e.childNodes.length;n++)e.childNodes[n].nodeType==r.ElementType.TEXT&&(t+=e.childNodes[n].nodeValue);return t},copyElement:function(e){var t,n;if(e.nodeType==r.ElementType.NORMAL){n=r.xmlElement(e.tagName);for(t=0;t<e.attributes.length;t++)n.setAttribute(e.attributes[t].nodeName.toLowerCase(),e.attributes[t].value);for(t=0;t<e.childNodes.length;t++)n.appendChild(r.copyElement(e.childNodes[t]))}else e.nodeType==r.ElementType.TEXT&&(n=r.xmlGenerator().createTextNode(e.nodeValue));return n},escapeNode:function(e){return e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(e){return e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(e){return e.indexOf("@")<0?null:e.split("@")[0]},getDomainFromJid:function(e){var t=r.getBareJidFromJid(e);if(t.indexOf("@")<0)return t;var n=t.split("@");return n.splice(0,1),n.join("@")},getResourceFromJid:function(e){var t=e.split("/");return t.length<2?null:(t.splice(0,1),t.join("/"))},getBareJidFromJid:function(e){return e?e.split("/")[0]:null},log:function(e,t){return},debug:function(e){this.log(this.LogLevel.DEBUG,e)},info:function(e){this.log(this.LogLevel.INFO,e)},warn:function(e){this.log(this.LogLevel.WARN,e)},error:function(e){this.log(this.LogLevel.ERROR,e)},fatal:function(e){this.log(this.LogLevel.FATAL,e)},serialize:function(e){var t;if(!e)return null;typeof e.tree=="function"&&(e=e.tree());var n=e.nodeName,i,s;e.getAttribute("_realname")&&(n=e.getAttribute("_realname")),t="<"+n;for(i=0;i<e.attributes.length;i++)e.attributes[i].nodeName!="_realname"&&(t+=" "+e.attributes[i].nodeName.toLowerCase()+"='"+e.attributes[i].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'");if(e.childNodes.length>0){t+=">";for(i=0;i<e.childNodes.length;i++){s=e.childNodes[i];switch(s.nodeType){case r.ElementType.NORMAL:t+=r.serialize(s);break;case r.ElementType.TEXT:t+=r.xmlescape(s.nodeValue);break;case r.ElementType.CDATA:t+="<![CDATA["+s.nodeValue+"]]>"}}t+="</"+n+">"}else t+="/>";return t},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(e,t){r._connectionPlugins[e]=t}},r.Builder=function(e,t){if(e=="presence"||e=="message"||e=="iq")t&&!t.xmlns?t.xmlns=r.NS.CLIENT:t||(t={xmlns:r.NS.CLIENT});this.nodeTree=r.xmlElement(e,t),this.node=this.nodeTree},r.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return r.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},attrs:function(e){for(var t in e)e.hasOwnProperty(t)&&this.node.setAttribute(t,e[t]);return this},c:function(e,t,n){var i=r.xmlElement(e,t,n);return this.node.appendChild(i),n||(this.node=i),this},cnode:function(e){var t=r.xmlGenerator();try{var n=t.importNode!==undefined}catch(i){var n=!1}var s=n?t.importNode(e,!0):r.copyElement(e);return this.node.appendChild(s),this.node=s,this},t:function(e){var t=r.xmlTextNode(e);return this.node.appendChild(t),this}},r.Handler=function(e,t,n,i,s,o,u){this.handler=e,this.ns=t,this.name=n,this.type=i,this.id=s,this.options=u||{matchbare:!1},this.options.matchBare||(this.options.matchBare=!1),this.options.matchBare?this.from=o?r.getBareJidFromJid(o):null:this.from=o,this.user=!0},r.Handler.prototype={isMatch:function(e){var t,n=null;this.options.matchBare?n=r.getBareJidFromJid(e.getAttribute("from")):n=e.getAttribute("from"),t=!1;if(!this.ns)t=!0;else{var i=this;r.forEachChild(e,null,function(e){e.getAttribute("xmlns")==i.ns&&(t=!0)}),t=t||e.getAttribute("xmlns")==this.ns}return!t||!!this.name&&!r.isTagEqual(e,this.name)||!!this.type&&e.getAttribute("type")!=this.type||!!this.id&&e.getAttribute("id")!=this.id||!!this.from&&n!=this.from?!1:!0},run:function(e){var t=null;try{t=this.handler(e)}catch(n){throw n.sourceURL?r.fatal("error: "+this.handler+" "+n.sourceURL+":"+n.line+" - "+n.name+": "+n.message):n.fileName?(typeof console!="undefined"&&(console.trace(),console.error(this.handler," - error - ",n,n.message)),r.fatal("error: "+this.handler+" "+n.fileName+":"+n.lineNumber+" - "+n.name+": "+n.message)):r.fatal("error: "+this.handler),n}return t},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},r.TimedHandler=function(e,t){this.period=e,this.handler=t,this.lastCalled=(new Date).getTime(),this.user=!0},r.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},r.Request=function(e,t,n,i){this.id=++r._requestId,this.xmlData=e,this.data=r.serialize(e),this.origFunc=t,this.func=t,this.rid=n,this.date=NaN,this.sends=i||0,this.abort=!1,this.dead=null,this.age=function(){if(!this.date)return 0;var e=new Date;return(e-this.date)/1e3},this.timeDead=function(){if(!this.dead)return 0;var e=new Date;return(e-this.dead)/1e3},this.xhr=this._newXHR()},r.Request.prototype={getResponse:function(){var e=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){e=this.xhr.responseXML.documentElement;if(e.tagName=="parsererror")throw r.error("invalid response received"),r.error("responseText: "+this.xhr.responseText),r.error("responseXML: "+r.serialize(this.xhr.responseXML)),"parsererror"}else this.xhr.responseText&&(r.error("invalid response received"),r.error("responseText: "+this.xhr.responseText),r.error("responseXML: "+r.serialize(this.xhr.responseXML)));return e},_newXHR:function(){var e=null;return window.XMLHttpRequest?(e=new XMLHttpRequest,e.overrideMimeType&&e.overrideMimeType("text/xml")):window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),e.onreadystatechange=this.func.bind(null,this),e}},r.Connection=function(e){this.service=e,this.jid="",this.rid=Math.floor(Math.random()*4294967295),this.sid=null,this.streamId=null,this.features=null,this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.disconnecting=!1,this.connected=!1,this.errors=0,this.paused=!1,this.hold=1,this.wait=60,this.window=5,this._data=[],this._requests=[],this._uniqueId=Math.round(Math.random()*1e4),this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var t in r._connectionPlugins)if(r._connectionPlugins.hasOwnProperty(t)){var n=r._connectionPlugins[t],i=function(){};i.prototype=n,this[t]=new i,this[t].init(this)}},r.Connection.prototype={reset:function(){this.rid=Math.floor(Math.random()*4294967295),this.sid=null,this.streamId=null,this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.disconnecting=!1,this.connected=!1,this.errors=0,this._requests=[],this._uniqueId=Math.round(Math.random()*1e4)},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(e){return typeof e=="string"||typeof e=="number"?++this._uniqueId+":"+e:++this._uniqueId+""},connect:function(e,t,n,i,s){this.jid=e,this.pass=t,this.connect_callback=n,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.errors=0,this.wait=i||this.wait,this.hold=s||this.hold,this.domain=r.getDomainFromJid(this.jid);var o=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":r.NS.BOSH});this._changeConnectStatus(r.Status.CONNECTING,null),this._requests.push(new r.Request(o.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),o.tree().getAttribute("rid"))),this._throttledRequestHandler()},attach:function(e,t,n,i,s,o,u){this.jid=e,this.sid=t,this.rid=n,this.connect_callback=i,this.domain=r.getDomainFromJid(this.jid),this.authenticated=!0,this.connected=!0,this.wait=s||this.wait,this.hold=o||this.hold,this.window=u||this.window,this._changeConnectStatus(r.Status.ATTACHED,null)},xmlInput:function(e){return},xmlOutput:function(e){return},rawInput:function(e){return},rawOutput:function(e){return},send:function(e){if(e===null)return;if(typeof e.sort=="function")for(var t=0;t<e.length;t++)this._queueData(e[t]);else typeof e.tree=="function"?this._queueData(e.tree()):this._queueData(e);this._throttledRequestHandler(),clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendIQ:function(e,t,n,r){var i=null,s=this;typeof e.tree=="function"&&(e=e.tree());var o=e.getAttribute("id");o||(o=this.getUniqueId("sendIQ"),e.setAttribute("id",o));var u=this.addHandler(function(e){i&&s.deleteTimedHandler(i);var r=e.getAttribute("type");if(r=="result")t&&t(e);else{if(r!="error")throw{name:"StropheError",message:"Got bad IQ type of "+r};n&&n(e)}},null,"iq",null,o);return r&&(i=this.addTimedHandler(r,function(){return s.deleteHandler(u),n&&n(null),!1})),this.send(e),o},_queueData:function(e){if(e===null||!e.tagName||!e.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(e)},_sendRestart:function(){this._data.push("restart"),this._throttledRequestHandler(),clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(e,t){var n=new r.TimedHandler(e,t);return this.addTimeds.push(n),n},deleteTimedHandler:function(e){this.removeTimeds.push(e)},addHandler:function(e,t,n,i,s,o,u){var a=new r.Handler(e,t,n,i,s,o,u);return this.addHandlers.push(a),a},deleteHandler:function(e){this.removeHandlers.push(e)},disconnect:function(e){this._changeConnectStatus(r.Status.DISCONNECTING,e),r.info("Disconnect was called because: "+e),this.connected&&(this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._sendTerminate())},_changeConnectStatus:function(e,t){for(var n in r._connectionPlugins)if(r._connectionPlugins.hasOwnProperty(n)){var i=this[n];if(i.statusChanged)try{i.statusChanged(e,t)}catch(s){r.error(""+n+" plugin caused an exception "+"changing status: "+s)}}if(this.connect_callback)try{this.connect_callback(e,t)}catch(o){r.error("User connection callback caused an exception: "+o)}},_buildBody:function(){var e=i("body",{rid:this.rid++,xmlns:r.NS.HTTPBIND});return this.sid!==null&&e.attrs({sid:this.sid}),e},_removeRequest:function(e){r.debug("removing request");var t;for(t=this._requests.length-1;t>=0;t--)e==this._requests[t]&&this._requests.splice(t,1);e.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(e){var t=this._requests[e];t.dead===null&&(t.dead=new Date),this._processRequest(e)},_processRequest:function(e){var t=this._requests[e],n=-1;try{t.xhr.readyState==4&&(n=t.xhr.status)}catch(i){r.error("caught an error in _requests["+e+"], reqStatus: "+n)}typeof n=="undefined"&&(n=-1);if(t.sends>5){this._onDisconnectTimeout();return}var s=t.age(),o=!isNaN(s)&&s>Math.floor(r.TIMEOUT*this.wait),u=t.dead!==null&&t.timeDead()>Math.floor(r.SECONDARY_TIMEOUT*this.wait),a=t.xhr.readyState==4&&(n<1||n>=500);if(o||u||a)u&&r.error("Request "+this._requests[e].id+" timed out (secondary), restarting"),t.abort=!0,t.xhr.abort(),t.xhr.onreadystatechange=function(){},this._requests[e]=new r.Request(t.xmlData,t.origFunc,t.rid,t.sends),t=this._requests[e];if(t.xhr.readyState===0){r.debug("request id "+t.id+"."+t.sends+" posting");try{t.xhr.open("POST",this.service,!0)}catch(f){r.error("XHR open failed."),this.connected||this._changeConnectStatus(r.Status.CONNFAIL,"bad-service"),this.disconnect();return}var l=function(){t.date=new Date,t.xhr.send(t.data)};if(t.sends>1){var c=Math.min(Math.floor(r.TIMEOUT*this.wait),Math.pow(t.sends,3))*1e3;setTimeout(l,c)}else l();t.sends++,this.xmlOutput!==r.Connection.prototype.xmlOutput&&this.xmlOutput(t.xmlData),this.rawOutput!==r.Connection.prototype.rawOutput&&this.rawOutput(t.data)}else r.debug("_processRequest: "+(e===0?"first":"second")+" request has readyState of "+t.xhr.readyState)},_throttledRequestHandler:function(){this._requests?r.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):r.debug("_throttledRequestHandler called with undefined requests");if(!this._requests||this._requests.length===0)return;this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1)},_onRequestStateChange:function(e,t){r.debug("request id "+t.id+"."+t.sends+" state changed to "+t.xhr.readyState);if(t.abort){t.abort=!1;return}var n;if(t.xhr.readyState==4){n=0;try{n=t.xhr.status}catch(i){}typeof n=="undefined"&&(n=0);if(this.disconnecting&&n>=400){this._hitError(n);return}var s=this._requests[0]==t,o=this._requests[1]==t;if(n>0&&n<500||t.sends>5)this._removeRequest(t),r.debug("request id "+t.id+" should now be removed");if(n==200)(o||s&&this._requests.length>0&&this._requests[0].age()>Math.floor(r.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),r.debug("request id "+t.id+"."+t.sends+" got 200"),e(t),this.errors=0;else{r.error("request id "+t.id+"."+t.sends+" error "+n+" happened");if(n===0||n>=400&&n<600||n>=12e3)this._hitError(n),n>=400&&n<500&&(this._changeConnectStatus(r.Status.DISCONNECTING,null),this._doDisconnect())}n>0&&n<500||t.sends>5||this._throttledRequestHandler()}},_hitError:function(e){this.errors++,r.warn("request errored, status: "+e+", number of errors: "+this.errors),this.errors>4&&this._onDisconnectTimeout()},_doDisconnect:function(){r.info("_doDisconnect was called"),this.authenticated=!1,this.disconnecting=!1,this.sid=null,this.streamId=null,this.rid=Math.floor(Math.random()*4294967295),this.connected&&(this._changeConnectStatus(r.Status.DISCONNECTED,null),this.connected=!1),this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[]},_dataRecv:function(e){try{var t=e.getResponse()}catch(n){if(n!="parsererror")throw n;this.disconnect("strophe-parsererror")}if(t===null)return;this.xmlInput!==r.Connection.prototype.xmlInput&&this.xmlInput(t),this.rawInput!==r.Connection.prototype.rawInput&&this.rawInput(r.serialize(t));var i,s;while(this.removeHandlers.length>0)s=this.removeHandlers.pop(),i=this.handlers.indexOf(s),i>=0&&this.handlers.splice(i,1);while(this.addHandlers.length>0)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._requests.length===0){this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null,this._doDisconnect();return}var o=t.getAttribute("type"),u,a;if(o!==null&&o=="terminate"){if(this.disconnecting)return;u=t.getAttribute("condition"),a=t.getElementsByTagName("conflict"),u!==null?(u=="remote-stream-error"&&a.length>0&&(u="conflict"),this._changeConnectStatus(r.Status.CONNFAIL,u)):this._changeConnectStatus(r.Status.CONNFAIL,"unknown"),this.disconnect();return}var f=this;r.forEachChild(t,null,function(e){var t,n;n=f.handlers,f.handlers=[];for(t=0;t<n.length;t++){var r=n[t];try{r.isMatch(e)&&(f.authenticated||!r.user)?r.run(e)&&f.handlers.push(r):f.handlers.push(r)}catch(i){}}})},_sendTerminate:function(){r.info("_sendTerminate was called");var e=this._buildBody().attrs({type:"terminate"});this.authenticated&&e.c("presence",{xmlns:r.NS.CLIENT,type:"unavailable"}),this.disconnecting=!0;var t=new r.Request(e.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),e.tree().getAttribute("rid"));this._requests.push(t),this._throttledRequestHandler()},_connect_cb:function(t){r.info("_connect_cb was called"),this.connected=!0;var n=t.getResponse();if(!n)return;this.xmlInput!==r.Connection.prototype.xmlInput&&this.xmlInput(n),this.rawInput!==r.Connection.prototype.rawInput&&this.rawInput(r.serialize(n));var s=n.getAttribute("type"),u,a;if(s!==null&&s=="terminate"){u=n.getAttribute("condition"),a=n.getElementsByTagName("conflict"),u!==null?(u=="remote-stream-error"&&a.length>0&&(u="conflict"),this._changeConnectStatus(r.Status.CONNFAIL,u)):this._changeConnectStatus(r.Status.CONNFAIL,"unknown");return}this.sid||(this.sid=n.getAttribute("sid")),this.stream_id||(this.stream_id=n.getAttribute("authid"));var f=n.getAttribute("requests");f&&(this.window=parseInt(f,10));var l=n.getAttribute("hold");l&&(this.hold=parseInt(l,10));var c=n.getAttribute("wait");c&&(this.wait=parseInt(c,10));var h=!1,p=!1,d=!1,v=n.getElementsByTagName("mechanism"),m,g,y,b;if(!(v.length>0)){var w=this._buildBody();this._requests.push(new r.Request(w.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),w.tree().getAttribute("rid"))),this._throttledRequestHandler();return}for(m=0;m<v.length;m++)g=r.getText(v[m]),g=="DIGEST-MD5"?p=!0:g=="PLAIN"?h=!0:g=="ANONYMOUS"&&(d=!0);r.getNodeFromJid(this.jid)===null&&d?(this._changeConnectStatus(r.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(i("auth",{xmlns:r.NS.SASL,mechanism:"ANONYMOUS"}).tree())):r.getNodeFromJid(this.jid)===null?(this._changeConnectStatus(r.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect()):p?(this._changeConnectStatus(r.Status.AUTHENTICATING,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge1_cb.bind(this),null,"challenge",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(i("auth",{xmlns:r.NS.SASL,mechanism:"DIGEST-MD5"}).tree())):h?(y=r.getBareJidFromJid(this.jid),y+="\0",y+=r.getNodeFromJid(this.jid),y+="\0",y+=this.pass,this._changeConnectStatus(r.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),b=e.encode(y),this.send(i("auth",{xmlns:r.NS.SASL,mechanism:"PLAIN"}).t(b).tree())):(this._changeConnectStatus(r.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(o({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:r.NS.AUTH}).c("username",{}).t(r.getNodeFromJid(this.jid)).tree()))},_sasl_challenge1_cb:function(n){var s=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,o=e.decode(r.getText(n)),u=t.hexdigest(""+Math.random()*1234567890),a="",f=null,l="",c="",h;this.deleteHandler(this._sasl_failure_handler);while(o.match(s)){h=o.match(s),o=o.replace(h[0],""),h[2]=h[2].replace(/^"(.+)"$/,"$1");switch(h[1]){case"realm":a=h[2];break;case"nonce":l=h[2];break;case"qop":c=h[2];break;case"host":f=h[2]}}var p="xmpp/"+this.domain;f!==null&&(p=p+"/"+f);var d=t.hash(r.getNodeFromJid(this.jid)+":"+a+":"+this.pass)+":"+l+":"+u,v="AUTHENTICATE:"+p,m="";return m+="username="+this._quote(r.getNodeFromJid(this.jid))+",",m+="realm="+this._quote(a)+",",m+="nonce="+this._quote(l)+",",m+="cnonce="+this._quote(u)+",",m+='nc="00000001",',m+='qop="auth",',m+="digest-uri="+this._quote(p)+",",m+="response="+this._quote(t.hexdigest(t.hexdigest(d)+":"+l+":00000001:"+u+":auth:"+t.hexdigest(v)))+",",m+='charset="utf-8"',this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge2_cb.bind(this),null,"challenge",null,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(i("response",{xmlns:r.NS.SASL}).t(e.encode(m)).tree()),!1},_quote:function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_challenge2_cb:function(e){return this.deleteHandler(this._sasl_success_handler),this.deleteHandler(this._sasl_failure_handler),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(i("response",{xmlns:r.NS.SASL}).tree()),!1},_auth1_cb:function(e){var t=o({type:"set",id:"_auth_2"}).c("query",{xmlns:r.NS.AUTH}).c("username",{}).t(r.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return r.getResourceFromJid(this.jid)||(this.jid=r.getBareJidFromJid(this.jid)+"/strophe"),t.up().c("resource",{}).t(r.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(t.tree()),!1},_sasl_success_cb:function(e){return r.info("SASL authentication succeeded."),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null),this._sendRestart(),!1},_sasl_auth1_cb:function(e){this.features=e;var t,n;for(t=0;t<e.childNodes.length;t++)n=e.childNodes[t],n.nodeName=="bind"&&(this.do_bind=!0),n.nodeName=="session"&&(this.do_session=!0);if(!this.do_bind)return this._changeConnectStatus(r.Status.AUTHFAIL,null),!1;this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var i=r.getResourceFromJid(this.jid);return i?this.send(o({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:r.NS.BIND}).c("resource",{}).t(i).tree()):this.send(o({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:r.NS.BIND}).tree()),!1},_sasl_bind_cb:function(e){if(e.getAttribute("type")=="error")return r.info("SASL binding failed."),this._changeConnectStatus(r.Status.AUTHFAIL,null),!1;var t=e.getElementsByTagName("bind"),n;if(!(t.length>0))return r.info("SASL binding failed."),this._changeConnectStatus(r.Status.AUTHFAIL,null),!1;n=t[0].getElementsByTagName("jid"),n.length>0&&(this.jid=r.getText(n[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(o({type:"set",id:"_session_auth_2"}).c("session",{xmlns:r.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(r.Status.CONNECTED,null)))},_sasl_session_cb:function(e){if(e.getAttribute("type")=="result")this.authenticated=!0,this._changeConnectStatus(r.Status.CONNECTED,null);else if(e.getAttribute("type")=="error")return r.info("Session creation failed."),this._changeConnectStatus(r.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(e){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._changeConnectStatus(r.Status.AUTHFAIL,null),!1},_auth2_cb:function(e){return e.getAttribute("type")=="result"?(this.authenticated=!0,this._changeConnectStatus(r.Status.CONNECTED,null)):e.getAttribute("type")=="error"&&(this._changeConnectStatus(r.Status.AUTHFAIL,null),this.disconnect()),!1},_addSysTimedHandler:function(e,t){var n=new r.TimedHandler(e,t);return n.user=!1,this.addTimeds.push(n),n},_addSysHandler:function(e,t,n,i,s){var o=new r.Handler(e,t,n,i,s);return o.user=!1,this.addHandlers.push(o),o},_onDisconnectTimeout:function(){r.info("_onDisconnectTimeout was called");var e;while(this._requests.length>0)e=this._requests.pop(),e.abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){};return this._doDisconnect(),!1},_onIdle:function(){var e,t,n,i;while(this.addTimeds.length>0)this.timedHandlers.push(this.addTimeds.pop());while(this.removeTimeds.length>0)t=this.removeTimeds.pop(),e=this.timedHandlers.indexOf(t),e>=0&&this.timedHandlers.splice(e,1);var s=(new Date).getTime();i=[];for(e=0;e<this.timedHandlers.length;e++){t=this.timedHandlers[e];if(this.authenticated||!t.user)n=t.lastCalled+t.period,n-s<=0?t.run()&&i.push(t):i.push(t)}this.timedHandlers=i;var o,u;this.authenticated&&this._requests.length===0&&this._data.length===0&&!this.disconnecting&&(r.info("no requests during idle cycle, sending blank request"),this._data.push(null));if(this._requests.length<2&&this._data.length>0&&!this.paused){o=this._buildBody();for(e=0;e<this._data.length;e++)this._data[e]!==null&&(this._data[e]==="restart"?o.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":r.NS.BOSH}):o.cnode(this._data[e]).up());delete this._data,this._data=[],this._requests.push(new r.Request(o.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),o.tree().getAttribute("rid"))),this._processRequest(this._requests.length-1)}this._requests.length>0&&(u=this._requests[0].age(),this._requests[0].dead!==null&&this._requests[0].timeDead()>Math.floor(r.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),u>Math.floor(r.TIMEOUT*this.wait)&&(r.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(r.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())),clearTimeout(this._idleTimeout),this.connected&&(this._idleTimeout=setTimeout(this._onIdle.bind(this),100))}},r.addConnectionPlugin("flxhr",{init:function(e){window.flensed&&window.flensed.flXHR?r.Request.prototype._newXHR=function(){var t=new window.flensed.flXHR({autoUpdatePlayer:!0,instancePooling:!0,noCacheHeader:!1,onerror:function(){e._changeConnectStatus(r.Status.CONNFAIL,"flXHR connection error"),e._onDisconnectTimeout()}});return t.onreadystatechange=this.func.bind(null,this),t}:r.error("flXHR plugin loaded, but flXHR not found.  Falling back to native XHR implementation.")}}),{strophe:r,build:i,msg:s,iq:o,pres:u}}()}),define("require/sound-manager",[],function(){(function(e){function n(t,n){function Yt(e){return function(t){var n=this._t;return!n||!n._a?(n&&n.sID?i._wD(a+"ignoring "+t.type+": "+n.sID):i._wD(a+"ignoring "+t.type),null):e.call(this,t)}}this.flashVersion=9,this.debugMode=!1,this.debugFlash=!1,this.useConsole=!0,this.consoleOnly=!0,this.waitForWindowLoad=!1,this.bgColor="#ffffff",this.useHighPerformance=!1,this.flashPollingInterval=null,this.html5PollingInterval=null,this.flashLoadTimeout=1e3,this.wmode=null,this.allowScriptAccess="sameDomain",this.useFlashBlock=!1,this.useHTML5Audio=!0,this.html5Test=/^(probably|maybe)$/i,this.preferFlash=!0,this.noSWFCache=!1,this.audioFormats={mp3:{type:['audio/mpeg; codecs="mp3"',"audio/mpeg","audio/mp3","audio/MPA","audio/mpa-robust"],required:!0},mp4:{related:["aac","m4a"],type:['audio/mp4; codecs="mp4a.40.2"',"audio/aac","audio/x-m4a","audio/MP4A-LATM","audio/mpeg4-generic"],required:!1},ogg:{type:["audio/ogg; codecs=vorbis"],required:!1},wav:{type:['audio/wav; codecs="1"',"audio/wav","audio/wave","audio/x-wav"],required:!1}},this.defaultOptions={autoLoad:!1,autoPlay:!1,from:null,loops:1,onid3:null,onload:null,whileloading:null,onplay:null,onpause:null,onresume:null,whileplaying:null,onposition:null,onstop:null,onfailure:null,onfinish:null,multiShot:!0,multiShotEvents:!1,position:null,pan:0,stream:!0,to:null,type:null,usePolicyFile:!1,volume:100},this.flash9Options={isMovieStar:null,usePeakData:!1,useWaveformData:!1,useEQData:!1,onbufferchange:null,ondataerror:null},this.movieStarOptions={bufferTime:3,serverURL:null,onconnect:null,duration:null},this.movieID="sm2-container",this.id=n||"sm2movie",this.debugID="soundmanager-debug",this.debugURLParam=/([#?&])debug=1/i,this.versionNumber="V2.97a.20120318",this.version=null,this.movieURL=null,this.url=t||null,this.altURL=null,this.swfLoaded=!1,this.enabled=!1,this.oMC=null,this.sounds={},this.soundIDs=[],this.muted=!1,this.didFlashBlock=!1,this.filePattern=null,this.filePatterns={flash8:/\.mp3(\?.*)?$/i,flash9:/\.mp3(\?.*)?$/i},this.features={buffering:!1,peakData:!1,waveformData:!1,eqData:!1,movieStar:!1},this.sandbox={type:null,types:{remote:"remote (domain-based) rules",localWithFile:"local with file access (no internet access)",localWithNetwork:"local with network (internet access only, no local access)",localTrusted:"local, trusted (local+internet access)"},description:null,noRemote:null,noLocal:null},this.hasHTML5=function(){try{return typeof Audio!="undefined"&&typeof (new Audio).canPlayType!="undefined"}catch(e){return!1}}(),this.html5={usingFlash:null},this.flash={},this.html5Only=!1,this.ignoreFlash=!1;var r,i=this,s=null,o="soundManager",u=o+"::",a="HTML5::",f,l=navigator.userAgent,c=e,h=c.location.href.toString(),p=document,d,v,m,g=[],y=!0,b,w=!1,E=!1,S=!1,x=!1,T=!1,N,C=0,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V=["log","info","warn","error"],$=8,J,K,Q,G=null,Y=null,Z,et,tt,nt,rt,it,st,ot,ut,at=!1,ft=!1,lt,ct,ht,pt=0,dt=null,vt,mt=null,gt,yt,bt,wt,Et,St,xt,Tt,Nt=Array.prototype.slice,Ct=!1,kt,Lt,At,Ot,Mt,_t=l.match(/(ipad|iphone|ipod)/i),Dt=l.match(/firefox/i),Pt=l.match(/droid/i),Ht=l.match(/msie/i),Bt=l.match(/webkit/i),jt=l.match(/safari/i)&&!l.match(/chrome/i),Ft=l.match(/opera/i),It=l.match(/(mobile|pre\/|xoom)/i)||_t,qt=!h.match(/usehtml5audio/i)&&!h.match(/sm2\-ignorebadua/i)&&jt&&!l.match(/silk/i)&&l.match(/OS X 10_6_([3-7])/i),Rt=typeof console!="undefined"&&typeof console.log!="undefined",Ut=typeof p.hasFocus!="undefined"?p.hasFocus():null,zt=jt&&typeof p.hasFocus=="undefined",Wt=!zt,Xt=/(mp3|mp4|mpa)/i,Vt="about:blank",$t=p.location?p.location.protocol.match(/http/i):null,Jt=$t?"":"http://",Kt=/^\s*audio\/(?:x-)?(?:mpeg4|aac|flv|mov|mp4||m4v|m4a|mp4v|3gp|3g2)\s*(?:$|;)/i,Qt=["mpeg4","aac","flv","mov","mp4","m4v","f4v","m4a","mp4v","3gp","3g2"],Gt=new RegExp("\\.("+Qt.join("|")+")(\\?.*)?$","i");this.mimePattern=/^\s*audio\/(?:x-)?(?:mp(?:eg|3))\s*(?:$|;)/i,this.useAltURL=!$t,this._global_a=null,nt={swfBox:"sm2-object-box",swfDefault:"movieContainer",swfError:"swf_error",swfTimedout:"swf_timedout",swfLoaded:"swf_loaded",swfUnblocked:"swf_unblocked",sm2Debug:"sm2_debug",highPerf:"high_performance",flashDebug:"flash_debug"},It&&(i.useHTML5Audio=!0,i.preferFlash=!1,_t&&(i.ignoreFlash=!0,Ct=!0)),this.ok=function(){return mt?S&&!x:i.useHTML5Audio&&i.hasHTML5},this.supported=this.ok,this.getMovie=function(e){return f(e)||p[e]||c[e]},this.createSound=function(e){function l(){return u=it(u),i.sounds[f.id]=new r(f),i.soundIDs.push(f.id),i.sounds[f.id]}var t,n,u=null,a=null,f=null;return t=o+".createSound(): ",n=t+Z(S?"notOK":"notReady"),!S||!i.ok()?(ot(n),!1):(arguments.length===2&&(e={id:arguments[0],url:arguments[1]}),u=L(e),u.url=vt(u.url),f=u,f.id.toString().charAt(0).match(/^[0-9]$/)&&i._wD(t+Z("badID",f.id),2),i._wD(t+f.id+" ("+f.url+")",1),ut(f.id,!0)?(i._wD(t+f.id+" exists",1),i.sounds[f.id]):(yt(f)?(a=l(),i._wD("Loading sound "+f.id+" via HTML5"),a._setup_html5(f)):(m>8&&(f.isMovieStar===null&&(f.isMovieStar=f.serverURL||(f.type?f.type.match(Kt):!1)||f.url.match(Gt)),f.isMovieStar&&i._wD(t+"using MovieStar handling"),f.isMovieStar&&(f.usePeakData&&(N("noPeak"),f.usePeakData=!1),f.loops>1&&N("noNSLoop"))),f=st(f,t),a=l(),m===8?s._createSound(f.id,f.loops||1,f.usePolicyFile):(s._createSound(f.id,f.url,f.usePeakData,f.useWaveformData,f.useEQData,f.isMovieStar,f.isMovieStar?f.bufferTime:!1,f.loops||1,f.serverURL,f.duration||null,f.autoPlay,!0,f.autoLoad,f.usePolicyFile),f.serverURL||(a.connected=!0,f.onconnect&&f.onconnect.apply(a))),!f.serverURL&&(f.autoLoad||f.autoPlay)&&a.load(f)),!f.serverURL&&f.autoPlay&&a.play(),a))},this.destroySound=function(e,t){if(!ut(e))return!1;var n=i.sounds[e],r;n._iO={},n.stop(),n.unload();for(r=0;r<i.soundIDs.length;r++)if(i.soundIDs[r]===e){i.soundIDs.splice(r,1);break}return t||n.destruct(!0),n=null,delete i.sounds[e],!0},this.load=function(e,t){return ut(e)?i.sounds[e].load(t):!1},this.unload=function(e){return ut(e)?i.sounds[e].unload():!1},this.onPosition=function(e,t,n,r){return ut(e)?i.sounds[e].onposition(t,n,r):!1},this.onposition=this.onPosition,this.clearOnPosition=function(e,t,n){return ut(e)?i.sounds[e].clearOnPosition(t,n):!1},this.play=function(e,t){return!S||!i.ok()?(ot(o+".play(): "+Z(S?"notOK":"notReady")),!1):ut(e)?i.sounds[e].play(t):(t instanceof Object||(t={url:t}),t&&t.url?(i._wD(o+'.play(): attempting to create "'+e+'"',1),t.id=e,i.createSound(t).play()):!1)},this.start=this.play,this.setPosition=function(e,t){return ut(e)?i.sounds[e].setPosition(t):!1},this.stop=function(e){return ut(e)?(i._wD(o+".stop("+e+")",1),i.sounds[e].stop()):!1},this.stopAll=function(){var e;i._wD(o+".stopAll()",1);for(e in i.sounds)i.sounds.hasOwnProperty(e)&&i.sounds[e].stop()},this.pause=function(e){return ut(e)?i.sounds[e].pause():!1},this.pauseAll=function(){var e;for(e=i.soundIDs.length-1;e>=0;e--)i.sounds[i.soundIDs[e]].pause()},this.resume=function(e){return ut(e)?i.sounds[e].resume():!1},this.resumeAll=function(){var e;for(e=i.soundIDs.length-1;e>=0;e--)i.sounds[i.soundIDs[e]].resume()},this.togglePause=function(e){return ut(e)?i.sounds[e].togglePause():!1},this.setPan=function(e,t){return ut(e)?i.sounds[e].setPan(t):!1},this.setVolume=function(e,t){return ut(e)?i.sounds[e].setVolume(t):!1},this.mute=function(e){var t=0;typeof e!="string"&&(e=null);if(!e){i._wD(o+".mute(): Muting all sounds");for(t=i.soundIDs.length-1;t>=0;t--)i.sounds[i.soundIDs[t]].mute();return i.muted=!0,!0}return ut(e)?(i._wD(o+'.mute(): Muting "'+e+'"'),i.sounds[e].mute()):!1},this.muteAll=function(){i.mute()},this.unmute=function(e){var t;typeof e!="string"&&(e=null);if(!e){i._wD(o+".unmute(): Unmuting all sounds");for(t=i.soundIDs.length-1;t>=0;t--)i.sounds[i.soundIDs[t]].unmute();return i.muted=!1,!0}return ut(e)?(i._wD(o+'.unmute(): Unmuting "'+e+'"'),i.sounds[e].unmute()):!1},this.unmuteAll=function(){i.unmute()},this.toggleMute=function(e){return ut(e)?i.sounds[e].toggleMute():!1},this.getMemoryUse=function(){var e=0;return s&&m!==8&&(e=parseInt(s._getMemoryUse(),10)),e},this.disable=function(e){var t;typeof e=="undefined"&&(e=!1);if(x)return!1;x=!0,N("shutdown",1);for(t=i.soundIDs.length-1;t>=0;t--)J(i.sounds[i.soundIDs[t]]);return k(e),Tt.remove(c,"load",M),!0},this.canPlayMIME=function(e){var t;return i.hasHTML5&&(t=bt({type:e})),!mt||t?t:e&&i.ok()?!!((m>8?e.match(Kt):null)||e.match(i.mimePattern)):null},this.canPlayURL=function(e){var t;return i.hasHTML5&&(t=bt({url:e})),!mt||t?t:e&&i.ok()?!!e.match(i.filePattern):null},this.canPlayLink=function(e){return typeof e.type!="undefined"&&e.type&&i.canPlayMIME(e.type)?!0:i.canPlayURL(e.href)},this.getSoundById=function(e,t){if(!e)throw new Error(o+".getSoundById(): sID is null/undefined");var n=i.sounds[e];return!n&&!t&&i._wD('"'+e+'" is an invalid sound ID.',2),n},this.onready=function(e,t){var n="onready";if(e&&e instanceof Function)return S&&i._wD(Z("queue",n)),t||(t=c),A(n,e,t),O(),!0;throw Z("needFunction",n)},this.ontimeout=function(e,t){var n="ontimeout";if(e&&e instanceof Function)return S&&i._wD(Z("queue",n)),t||(t=c),A(n,e,t),O({type:n}),!0;throw Z("needFunction",n)},this._writeDebug=function(e,t,n){var r="soundmanager-debug",s,o,u;if(!i.debugMode)return!1;typeof n!="undefined"&&n&&(e=e+" | "+(new Date).getTime());if(Rt&&i.useConsole){u=V[t],typeof console[u]!="undefined"?console[u](e):console.log(e);if(i.consoleOnly)return!0}try{s=f(r);if(!s)return!1;o=p.createElement("div"),++C%2===0&&(o.className="sm2-alt"),typeof t=="undefined"?t=0:t=parseInt(t,10),o.appendChild(p.createTextNode(e)),t&&(t>=2&&(o.style.fontWeight="bold"),t===3&&(o.style.color="#ff3333")),s.insertBefore(o,s.firstChild)}catch(a){}return s=null,!0},this._wD=this._writeDebug,this._debug=function(){var e,t;N("currentObj",1);for(e=0,t=i.soundIDs.length;e<t;e++)i.sounds[i.soundIDs[e]]._debug()},this.reboot=function(){i._wD(o+".reboot()"),i.soundIDs.length&&i._wD("Destroying "+i.soundIDs.length+" SMSound objects...");var e,t;for(e=i.soundIDs.length-1;e>=0;e--)i.sounds[i.soundIDs[e]].destruct();try{Ht&&(Y=s.innerHTML),G=s.parentNode.removeChild(s),i._wD("Flash movie removed.")}catch(n){N("badRemove",2)}Y=G=mt=null,i.enabled=q=S=at=ft=w=E=x=i.swfLoaded=!1,i.soundIDs=[],i.sounds={},s=null;for(e in g)if(g.hasOwnProperty(e))for(t=g[e].length-1;t>=0;t--)g[e][t].fired=!1;i._wD(o+": Rebooting..."),c.setTimeout(i.beginDelayedInit,20)},this.getMoviePercent=function(){return s&&typeof s.PercentLoaded!="undefined"?s.PercentLoaded():null},this.beginDelayedInit=function(){T=!0,F(),setTimeout(function(){return ft?!1:(U(),j(),ft=!0,!0)},20),_()},this.destruct=function(){i._wD(o+".destruct()"),i.disable(!0)},r=function(e){var t=this,n,r,o,u,f,l,c=!1,h=[],p=0,d,v,g=null,y;y={duration:null,time:null},this.sID=e.id,this.url=e.url,this.options=L(e),this.instanceOptions=this.options,this._iO=this.instanceOptions,this.pan=this.options.pan,this.volume=this.options.volume,this.isHTML5=!1,this._a=null,this.id3={},this._debug=function(){if(i.debugMode){var e=null,n=[],r,s,o=64;for(e in t.options)t.options[e]!==null&&(t.options[e]instanceof Function?(r=t.options[e].toString(),r=r.replace(/\s\s+/g," "),s=r.indexOf("{"),n.push(" "+e+": {"+r.substr(s+1,Math.min(Math.max(r.indexOf("\n")-1,o),o)).replace(/\n/g,"")+"... }")):n.push(" "+e+": "+t.options[e]));i._wD("SMSound() merged options: {\n"+n.join(", \n")+"\n}")}},this._debug(),this.load=function(e){var n=null,r;typeof e!="undefined"?(t._iO=L(e,t.options),t.instanceOptions=t._iO):(e=t.options,t._iO=e,t.instanceOptions=t._iO,g&&g!==t.url&&(N("manURL"),t._iO.url=t.url,t.url=null)),t._iO.url||(t._iO.url=t.url),t._iO.url=vt(t._iO.url),i._wD("SMSound.load(): "+t._iO.url,1);if(t._iO.url===t.url&&t.readyState!==0&&t.readyState!==2)return N("onURL",1),t.readyState===3&&t._iO.onload&&t._iO.onload.apply(t,[!!t.duration]),t;r=t._iO,g=t.url,t.loaded=!1,t.readyState=1,t.playState=0;if(yt(r))n=t._setup_html5(r),n._called_load?i._wD(a+"ignoring request to load again: "+t.sID):(i._wD(a+"load: "+t.sID),t._html5_canplay=!1,t._a.autobuffer="auto",t._a.preload="auto",n.load(),n._called_load=!0,r.autoPlay&&t.play());else try{t.isHTML5=!1,t._iO=st(it(r)),r=t._iO,m===8?s._load(t.sID,r.url,r.stream,r.autoPlay,r.whileloading?1:0,r.loops||1,r.usePolicyFile):s._load(t.sID,r.url,!!r.stream,!!r.autoPlay,r.loops||1,!!r.autoLoad,r.usePolicyFile)}catch(o){N("smError",2),b("onload",!1),z({type:"SMSOUND_LOAD_JS_EXCEPTION",fatal:!0})}return t},this.unload=function(){return t.readyState!==0&&(i._wD('SMSound.unload(): "'+t.sID+'"'),t.isHTML5?(u(),t._a&&(t._a.pause(),Et(t._a))):m===8?s._unload(t.sID,Vt):s._unload(t.sID),n()),t},this.destruct=function(e){i._wD('SMSound.destruct(): "'+t.sID+'"'),t.isHTML5?(u(),t._a&&(t._a.pause(),Et(t._a),Ct||o(),t._a._t=null,t._a=null)):(t._iO.onfailure=null,s._destroySound(t.sID)),e||i.destroySound(t.sID,!0)},this.play=function(e,n){var r,o,u,a;r="SMSound.play(): ",n=n===undefined?!0:n,e||(e={}),t._iO=L(e,t._iO),t._iO=L(t._iO,t.options),t._iO.url=vt(t._iO.url),t.instanceOptions=t._iO;if(t._iO.serverURL&&!t.connected)return t.getAutoPlay()||(i._wD(r+" Netstream not connected yet - setting autoPlay"),t.setAutoPlay(!0)),t;yt(t._iO)&&(t._setup_html5(t._iO),f());if(t.playState===1&&!t.paused){o=t._iO.multiShot;if(!o)return i._wD(r+'"'+t.sID+'" already playing (one-shot)',1),t;i._wD(r+'"'+t.sID+'" already playing (multi-shot)',1)}if(!t.loaded)if(t.readyState===0)i._wD(r+'Attempting to load "'+t.sID+'"',1),t.isHTML5||(t._iO.autoPlay=!0),t.load(t._iO);else{if(t.readyState===2)return i._wD(r+'Could not load "'+t.sID+'" - exiting',2),t;i._wD(r+'"'+t.sID+'" is loading - attempting to play..',1)}else i._wD(r+'"'+t.sID+'"');!t.isHTML5&&m===9&&t.position>0&&t.position===t.duration&&(i._wD(r+'"'+t.sID+'": Sound at end, resetting to position:0'),e.position=0);if(t.paused&&t.position&&t.position>0)i._wD(r+'"'+t.sID+'" is resuming from paused state',1),t.resume();else{t._iO=L(e,t._iO);if(t._iO.from!==null&&t._iO.to!==null&&t.instanceCount===0&&t.playState===0&&!t._iO.serverURL){a=function(){t._iO=L(e,t._iO),t.play(t._iO)};if(t.isHTML5&&!t._html5_canplay)return i._wD(r+'Beginning load of "'+t.sID+'" for from/to case'),t.load({_oncanplay:a}),!1;if(!t.isHTML5&&!t.loaded&&(!t.readyState||t.readyState!==2))return i._wD(r+'Preloading "'+t.sID+'" for from/to case'),t.load({onload:a}),!1;t._iO=v()}i._wD(r+'"'+t.sID+'" is starting to play'),(!t.instanceCount||t._iO.multiShotEvents||!t.isHTML5&&m>8&&!t.getAutoPlay())&&t.instanceCount++,t.playState===0&&t._iO.onposition&&l(t),t.playState=1,t.paused=!1,t.position=typeof t._iO.position!="undefined"&&!isNaN(t._iO.position)?t._iO.position:0,t.isHTML5||(t._iO=st(it(t._iO))),t._iO.onplay&&n&&(t._iO.onplay.apply(t),c=!0),t.setVolume(t._iO.volume,!0),t.setPan(t._iO.pan,!0),t.isHTML5?(f(),u=t._setup_html5(),t.setPosition(t._iO.position),u.play()):s._start(t.sID,t._iO.loops||1,m===9?t._iO.position:t._iO.position/1e3)}return t},this.start=this.play,this.stop=function(e){var n=t._iO,r;return t.playState===1&&(t._onbufferchange(0),t._resetOnPosition(0),t.paused=!1,t.isHTML5||(t.playState=0),d(),n.to&&t.clearOnPosition(n.to),t.isHTML5?t._a&&(r=t.position,t.setPosition(0),t.position=r,t._a.pause(),t.playState=0,t._onTimer(),u()):(s._stop(t.sID,e),n.serverURL&&t.unload()),t.instanceCount=0,t._iO={},n.onstop&&n.onstop.apply(t)),t},this.setAutoPlay=function(e){i._wD("sound "+t.sID+" turned autoplay "+(e?"on":"off")),t._iO.autoPlay=e,t.isHTML5||(s._setAutoPlay(t.sID,e),e&&!t.instanceCount&&t.readyState===1&&(t.instanceCount++,i._wD("sound "+t.sID+" incremented instance count to "+t.instanceCount)))},this.getAutoPlay=function(){return t._iO.autoPlay},this.setPosition=function(e){e===undefined&&(e=0);var n,r,o,u=t.isHTML5?Math.max(e,0):Math.min(t.duration||t._iO.duration,Math.max(e,0));n=t.position,t.position=u,o=t.position/1e3,t._resetOnPosition(t.position),t._iO.position=u;if(!t.isHTML5)r=m===9?t.position:o,t.readyState&&t.readyState!==2&&s._setPosition(t.sID,r,t.paused||!t.playState);else if(t._a)if(t._html5_canplay){if(t._a.currentTime!==o){i._wD("setPosition("+o+"): setting position");try{t._a.currentTime=o,(t.playState===0||t.paused)&&t._a.pause()}catch(a){i._wD("setPosition("+o+"): setting position failed: "+a.message,2)}}}else i._wD("setPosition("+o+"): delaying, sound not ready");return t.isHTML5&&t.paused&&t._onTimer(!0),t},this.pause=function(e){return t.paused||t.playState===0&&t.readyState!==1?t:(i._wD("SMSound.pause()"),t.paused=!0,t.isHTML5?(t._setup_html5().pause(),u()):(e||e===undefined)&&s._pause(t.sID),t._iO.onpause&&t._iO.onpause.apply(t),t)},this.resume=function(){var e=t._iO;return t.paused?(i._wD("SMSound.resume()"),t.paused=!1,t.playState=1,t.isHTML5?(t._setup_html5().play(),f()):(e.isMovieStar&&!e.serverURL&&t.setPosition(t.position),s._pause(t.sID)),!c&&e.onplay?(e.onplay.apply(t),c=!0):e.onresume&&e.onresume.apply(t),t):t},this.togglePause=function(){return i._wD("SMSound.togglePause()"),t.playState===0?(t.play({position:m===9&&!t.isHTML5?t.position:t.position/1e3}),t):(t.paused?t.resume():t.pause(),t)},this.setPan=function(e,n){return typeof e=="undefined"&&(e=0),typeof n=="undefined"&&(n=!1),t.isHTML5||s._setPan(t.sID,e),t._iO.pan=e,n||(t.pan=e,t.options.pan=e),t},this.setVolume=function(e,n){return typeof e=="undefined"&&(e=100),typeof n=="undefined"&&(n=!1),t.isHTML5?t._a&&(t._a.volume=Math.max(0,Math.min(1,e/100))):s._setVolume(t.sID,i.muted&&!t.muted||t.muted?0:e),t._iO.volume=e,n||(t.volume=e,t.options.volume=e),t},this.mute=function(){return t.muted=!0,t.isHTML5?t._a&&(t._a.muted=!0):s._setVolume(t.sID,0),t},this.unmute=function(){t.muted=!1;var e=typeof t._iO.volume!="undefined";return t.isHTML5?t._a&&(t._a.muted=!1):s._setVolume(t.sID,e?t._iO.volume:t.options.volume),t},this.toggleMute=function(){return t.muted?t.unmute():t.mute()},this.onPosition=function(e,n,r){return h.push({position:parseInt(e,10),method:n,scope:typeof r!="undefined"?r:t,fired:!1}),t},this.onposition=this.onPosition,this.clearOnPosition=function(e,t){var n;e=parseInt(e,10);if(isNaN(e))return!1;for(n=0;n<h.length;n++)e===h[n].position&&(!t||t===h[n].method)&&(h[n].fired&&p--,h.splice(n,1))},this._processOnPosition=function(){var e,n,r=h.length;if(!r||!t.playState||p>=r)return!1;for(e=r-1;e>=0;e--)n=h[e],!n.fired&&t.position>=n.position&&(n.fired=!0,p++,n.method.apply(n.scope,[n.position]));return!0},this._resetOnPosition=function(e){var t,n,r=h.length;if(!r)return!1;for(t=r-1;t>=0;t--)n=h[t],n.fired&&e<=n.position&&(n.fired=!1,p--);return!0},v=function(){var e=t._iO,n=e.from,r=e.to,s,o;return o=function(){i._wD(t.sID+': "to" time of '+r+" reached."),t.clearOnPosition(r,o),t.stop()},s=function(){i._wD(t.sID+': playing "from" '+n),r!==null&&!isNaN(r)&&t.onPosition(r,o)},n!==null&&!isNaN(n)&&(e.position=n,e.multiShot=!1,s()),e},l=function(){var e,n=t._iO.onposition;if(n)for(e in n)n.hasOwnProperty(e)&&t.onPosition(parseInt(e,10),n[e])},d=function(){var e,n=t._iO.onposition;if(n)for(e in n)n.hasOwnProperty(e)&&t.clearOnPosition(parseInt(e,10))},f=function(){t.isHTML5&&lt(t)},u=function(){t.isHTML5&&ct(t)},n=function(){h=[],p=0,c=!1,t._hasTimer=null,t._a=null,t._html5_canplay=!1,t.bytesLoaded=null,t.bytesTotal=null,t.duration=t._iO&&t._iO.duration?t._iO.duration:null,t.durationEstimate=null,t.eqData=[],t.eqData.left=[],t.eqData.right=[],t.failures=0,t.isBuffering=!1,t.instanceOptions={},t.instanceCount=0,t.loaded=!1,t.metadata={},t.readyState=0,t.muted=!1,t.paused=!1,t.peakData={left:0,right:0},t.waveformData={left:[],right:[]},t.playState=0,t.position=null},n(),this._onTimer=function(e){var n,r=!1,i,s={};if(t._hasTimer||e)return t._a&&(e||(t.playState>0||t.readyState===1)&&!t.paused)?(n=t._get_html5_duration(),n!==y.duration&&(y.duration=n,t.duration=n,r=!0),t.durationEstimate=t.duration,i=t._a.currentTime*1e3||0,i!==y.time&&(y.time=i,r=!0),(r||e)&&t._whileplaying(i,s,s,s,s),r):!1},this._get_html5_duration=function(){var e=t._iO,n=t._a?t._a.duration*1e3:e?e.duration:undefined,r=n&&!isNaN(n)&&n!==Infinity?n:e?e.duration:null;return r},this._setup_html5=function(e){var s=L(t._iO,e),o=decodeURI,u=Ct?i._global_a:t._a,a=o(s.url),f=u&&u._t?u._t.instanceOptions:null;if(u){if(u._t){if(!Ct&&a===o(g))return u;if(Ct&&f.url===s.url&&(!g||g===f.url))return u}i._wD("setting new URL on existing object: "+a+(g?", old URL: "+g:"")),Ct&&u._t&&u._t.playState&&s.url!==f.url&&u._t.stop(),n(),u.src=s.url,t.url=s.url,g=s.url,u._called_load=!1}else i._wD("creating HTML5 Audio() element with URL: "+a),u=new Audio(s.url),u._called_load=!1,Pt&&(u._called_load=!0),Ct&&(i._global_a=u);return t.isHTML5=!0,t._a=u,u._t=t,r(),u.loop=s.loops>1?"loop":"",s.autoLoad||s.autoPlay?t.load():(u.autobuffer=!1,u.preload="none"),u.loop=s.loops>1?"loop":"",u},r=function(){function n(e,n,r){return t._a?t._a.addEventListener(e,n,r||!1):null}if(t._a._added_events)return!1;var e;i._wD(a+"adding event listeners: "+t.sID),t._a._added_events=!0;for(e in Ot)Ot.hasOwnProperty(e)&&n(e,Ot[e]);return!0},o=function(){function n(e,n,r){return t._a?t._a.removeEventListener(e,n,r||!1):null}var e;i._wD(a+"removing event listeners: "+t.sID),t._a._added_events=!1;for(e in Ot)Ot.hasOwnProperty(e)&&n(e,Ot[e])},this._onload=function(e){var n,r=!!e;return n="SMSound._onload(): ",i._wD(n+'"'+t.sID+'"'+(r?" loaded.":" failed to load? - "+t.url),r?1:2),!r&&!t.isHTML5&&(i.sandbox.noRemote===!0&&i._wD(n+Z("noNet"),1),i.sandbox.noLocal===!0&&i._wD(n+Z("noLocal"),1)),t.loaded=r,t.readyState=r?3:2,t._onbufferchange(0),t._iO.onload&&t._iO.onload.apply(t,[r]),!0},this._onbufferchange=function(e){return t.playState===0?!1:e&&t.isBuffering||!e&&!t.isBuffering?!1:(t.isBuffering=e===1,t._iO.onbufferchange&&(i._wD("SMSound._onbufferchange(): "+e),t._iO.onbufferchange.apply(t)),!0)},this._onsuspend=function(){return t._iO.onsuspend&&(i._wD("SMSound._onsuspend()"),t._iO.onsuspend.apply(t)),!0},this._onfailure=function(e,n,r){t.failures++,i._wD('SMSound._onfailure(): "'+t.sID+'" count '+t.failures),t._iO.onfailure&&t.failures===1?t._iO.onfailure(t,e,n,r):i._wD("SMSound._onfailure(): ignoring")},this._onfinish=function(){var e=t._iO.onfinish;t._onbufferchange(0),t._resetOnPosition(0),t.instanceCount&&(t.instanceCount--,t.instanceCount||(d(),t.playState=0,t.paused=!1,t.instanceCount=0,t.instanceOptions={},t._iO={},u()),(!t.instanceCount||t._iO.multiShotEvents)&&e&&(i._wD('SMSound._onfinish(): "'+t.sID+'"'),e.apply(t)))},this._whileloading=function(e,n,r,i){var s=t._iO;t.bytesLoaded=e,t.bytesTotal=n,t.duration=Math.floor(r),t.bufferLength=i,s.isMovieStar?(t.durationEstimate=t.duration,t.readyState!==3&&s.whileloading&&s.whileloading.apply(t)):(s.duration?t.durationEstimate=t.duration>s.duration?t.duration:s.duration:t.durationEstimate=parseInt(t.bytesTotal/t.bytesLoaded*t.duration,10),t.durationEstimate===undefined&&(t.durationEstimate=t.duration),t.readyState!==3&&s.whileloading&&s.whileloading.apply(t))},this._whileplaying=function(e,n,r,i,s){var o=t._iO,u;return isNaN(e)||e===null?!1:(t.position=e,t._processOnPosition(),!t.isHTML5&&m>8&&(o.usePeakData&&typeof n!="undefined"&&n&&(t.peakData={left:n.leftPeak,right:n.rightPeak}),o.useWaveformData&&typeof r!="undefined"&&r&&(t.waveformData={left:r.split(","),right:i.split(",")}),o.useEQData&&typeof s!="undefined"&&s&&s.leftEQ&&(u=s.leftEQ.split(","),t.eqData=u,t.eqData.left=u,typeof s.rightEQ!="undefined"&&s.rightEQ&&(t.eqData.right=s.rightEQ.split(",")))),t.playState===1&&(!t.isHTML5&&m===8&&!t.position&&t.isBuffering&&t._onbufferchange(0),o.whileplaying&&o.whileplaying.apply(t)),!0)},this._onmetadata=function(e,n){i._wD('SMSound._onmetadata(): "'+this.sID+'" metadata received.');var r={},s,o;for(s=0,o=e.length;s<o;s++)r[e[s]]=n[s];t.metadata=r,t._iO.onmetadata&&t._iO.onmetadata.apply(t)},this._onid3=function(e,n){i._wD('SMSound._onid3(): "'+this.sID+'" ID3 data received.');var r=[],s,o;for(s=0,o=e.length;s<o;s++)r[e[s]]=n[s];t.id3=L(t.id3,r),t._iO.onid3&&t._iO.onid3.apply(t)},this._onconnect=function(e){e=e===1,i._wD('SMSound._onconnect(): "'+t.sID+'"'+(e?" connected.":" failed to connect? - "+t.url),e?1:2),t.connected=e,e&&(t.failures=0,ut(t.sID)&&(t.getAutoPlay()?t.play(undefined,t.getAutoPlay()):t._iO.autoLoad&&t.load()),t._iO.onconnect&&t._iO.onconnect.apply(t,[e]))},this._ondataerror=function(e){t.playState>0&&(i._wD("SMSound._ondataerror(): "+e),t._iO.ondataerror&&t._iO.ondataerror.apply(t))}},R=function(){return p.body||p._docElement||p.getElementsByTagName("div")[0]},f=function(e){return p.getElementById(e)},L=function(e,t){var n={},r,s,o;for(r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);s=typeof t=="undefined"?i.defaultOptions:t;for(o in s)s.hasOwnProperty(o)&&typeof n[o]=="undefined"&&(n[o]=s[o]);return n},Tt=function(){function n(t){var n=Nt.call(t),r=n.length;return e?(n[1]="on"+n[1],r>3&&n.pop()):r===3&&n.push(!1),n}function r(n,r){var i=n.shift(),s=[t[r]];e?i[s](n[0],n[1]):i[s].apply(i,n)}function i(){r(n(arguments),"add")}function s(){r(n(arguments),"remove")}var e=c.attachEvent,t={add:e?"attachEvent":"addEventListener",remove:e?"detachEvent":"removeEventListener"};return{add:i,remove:s}}(),Ot={abort:Yt(function(){i._wD(a+"abort: "+this._t.sID)}),canplay:Yt(function(){var e=this._t,t;if(e._html5_canplay)return!0;e._html5_canplay=!0,i._wD(a+"canplay: "+e.sID+", "+e.url),e._onbufferchange(0),t=isNaN(e.position)?null:e.position/1e3;if(e.position&&this.currentTime!==t){i._wD(a+"canplay: setting position to "+t);try{this.currentTime=t}catch(n){i._wD(a+"setting position failed: "+n.message,2)}}e._iO._oncanplay&&e._iO._oncanplay()}),load:Yt(function(){var e=this._t;e.loaded||(e._onbufferchange(0),e._whileloading(e.bytesTotal,e.bytesTotal,e._get_html5_duration()),e._onload(!0))}),ended:Yt(function(){var e=this._t;i._wD(a+"ended: "+e.sID),e._onfinish()}),error:Yt(function(){i._wD(a+"error: "+this.error.code),this._t._onload(!1)}),loadeddata:Yt(function(){var e=this._t,t=e.bytesTotal||1;i._wD(a+"loadeddata: "+this._t.sID),!e._loaded&&!jt&&(e.duration=e._get_html5_duration(),e._whileloading(t,t,e._get_html5_duration()),e._onload(!0))}),loadedmetadata:Yt(function(){i._wD(a+"loadedmetadata: "+this._t.sID)}),loadstart:Yt(function(){i._wD(a+"loadstart: "+this._t.sID),this._t._onbufferchange(1)}),play:Yt(function(){i._wD(a+"play: "+this._t.sID+", "+this._t.url),this._t._onbufferchange(0)}),playing:Yt(function(){i._wD(a+"playing: "+this._t.sID),this._t._onbufferchange(0)}),progress:Yt(function(e){var t=this._t,n,r,s,o=0,u=e.type==="progress",f=e.target.buffered,l=e.loaded||0,c=e.total||1;if(t.loaded)return!1;if(f&&f.length){for(n=f.length-1;n>=0;n--)o=f.end(n)-f.start(n);l=o/e.target.duration;if(u&&f.length>1){s=[],r=f.length;for(n=0;n<r;n++)s.push(e.target.buffered.start(n)+"-"+e.target.buffered.end(n));i._wD(a+"progress: timeRanges: "+s.join(", "))}u&&!isNaN(l)&&i._wD(a+"progress: "+t.sID+": "+Math.floor(l*100)+"% loaded")}isNaN(l)||(t._onbufferchange(0),t._whileloading(l,c,t._get_html5_duration()),l&&c&&l===c&&Ot.load.call(this,e))}),ratechange:Yt(function(){i._wD(a+"ratechange: "+this._t.sID)}),suspend:Yt(function(e){var t=this._t;i._wD(a+"suspend: "+t.sID),Ot.progress.call(this,e),t._onsuspend()}),stalled:Yt(function(){i._wD(a+"stalled: "+this._t.sID)}),timeupdate:Yt(function(){this._t._onTimer()}),waiting:Yt(function(){var e=this._t;i._wD(a+"waiting: "+e.sID),e._onbufferchange(1)})},yt=function(e){return!e.serverURL&&(e.type?bt({type:e.type}):bt({url:e.url})||i.html5Only)},Et=function(e){e&&(e.src=Dt?"":Vt)},bt=function(e){function f(e){return i.preferFlash&&kt&&!i.ignoreFlash&&typeof i.flash[e]!="undefined"&&i.flash[e]}if(!i.useHTML5Audio||!i.hasHTML5)return!1;var t=e.url||null,n=e.type||null,r=i.audioFormats,s,o,u,a;if(n&&typeof i.html5[n]!="undefined")return i.html5[n]&&!f(n);if(!wt){wt=[];for(a in r)r.hasOwnProperty(a)&&(wt.push(a),r[a].related&&(wt=wt.concat(r[a].related)));wt=new RegExp("\\.("+wt.join("|")+")(\\?.*)?$","i")}u=t?t.toLowerCase().match(wt):null;if(!u||!u.length){if(!n)return!1;o=n.indexOf(";"),u=(o!==-1?n.substr(0,o):n).substr(6)}else u=u[1];return u&&typeof i.html5[u]!="undefined"?i.html5[u]&&!f(u):(n="audio/"+u,s=i.html5.canPlayType({type:n}),i.html5[u]=s,s&&i.html5[n]&&!f(n))},xt=function(){function o(t){var n,r,s,o=!1;if(!e||typeof e.canPlayType!="function")return!1;if(t instanceof Array){for(r=0,s=t.length;r<s&&!o;r++)if(i.html5[t[r]]||e.canPlayType(t[r]).match(i.html5Test))o=!0,i.html5[t[r]]=!0,i.flash[t[r]]=!!(i.preferFlash&&kt&&t[r].match(Xt));return o}return n=e&&typeof e.canPlayType=="function"?e.canPlayType(t):!1,!!n&&!!n.match(i.html5Test)}if(!i.useHTML5Audio||typeof Audio=="undefined")return!1;var e=typeof Audio!="undefined"?Ft?new Audio(null):new Audio:null,t,n={},r,s;r=i.audioFormats;for(t in r)if(r.hasOwnProperty(t)){n[t]=o(r[t].type),n["audio/"+t]=n[t],i.preferFlash&&!i.ignoreFlash&&t.match(Xt)?i.flash[t]=!0:i.flash[t]=!1;if(r[t]&&r[t].related)for(s=r[t].related.length-1;s>=0;s--)n["audio/"+r[t].related[s]]=n[t],i.html5[r[t].related[s]]=n[t],i.flash[r[t].related[s]]=n[t]}return n.canPlayType=e?o:null,i.html5=L(i.html5,n),!0},B={notReady:"Not loaded yet - wait for soundManager.onload()/onready()",notOK:"Audio support is not available.",domError:u+"createMovie(): appendChild/innerHTML call failed. DOM not ready or other error.",spcWmode:u+"createMovie(): Removing wmode, preventing known SWF loading issue(s)",swf404:o+": Verify that %s is a valid path.",tryDebug:"Try "+o+".debugFlash = true for more security details (output goes to SWF.)",checkSWF:"See SWF output for more debug info.",localFail:o+": Non-HTTP page ("+p.location.protocol+" URL?) Review Flash player security settings for this special case:\nhttp://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html\nMay need to add/allow path, eg. c:/sm2/ or /users/me/sm2/",waitFocus:o+": Special case: Waiting for focus-related event..",waitImpatient:o+": Getting impatient, still waiting for Flash%s...",waitForever:o+": Waiting indefinitely for Flash (will recover if unblocked)...",needFunction:o+": Function object expected for %s",badID:'Warning: Sound ID "%s" should be a string, starting with a non-numeric character',currentObj:"--- "+o+"._debug(): Current sound objects ---",waitEI:u+"initMovie(): Waiting for ExternalInterface call from Flash..",waitOnload:o+": Waiting for window.onload()",docLoaded:o+": Document already loaded",onload:u+"initComplete(): calling soundManager.onload()",onloadOK:o+".onload() complete",init:u+"init()",didInit:u+"init(): Already called?",flashJS:o+": Attempting to call Flash from JS..",secNote:"Flash security note: Network/internet URLs will not load due to security restrictions. Access can be configured via Flash Player Global Security Settings Page: http://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html",badRemove:"Warning: Failed to remove flash movie.",noPeak:"Warning: peakData features unsupported for movieStar formats",shutdown:o+".disable(): Shutting down",queue:o+": Queueing %s handler",smFail:o+": Failed to initialise.",smError:"SMSound.load(): Exception: JS-Flash communication failed, or JS error.",fbTimeout:"No flash response, applying ."+nt.swfTimedout+" CSS..",fbLoaded:"Flash loaded",fbHandler:u+"flashBlockHandler()",manURL:"SMSound.load(): Using manually-assigned URL",onURL:o+".load(): current URL already assigned.",badFV:o+'.flashVersion must be 8 or 9. "%s" is invalid. Reverting to %s.',as2loop:"Note: Setting stream:false so looping can work (flash 8 limitation)",noNSLoop:"Note: Looping not implemented for MovieStar formats",needfl9:"Note: Switching to flash 9, required for MP4 formats.",mfTimeout:"Setting flashLoadTimeout = 0 (infinite) for off-screen, mobile flash case",mfOn:"mobileFlash::enabling on-screen flash repositioning",policy:"Enabling usePolicyFile for data access"},Z=function(){var e=Nt.call(arguments),t=e.shift(),n=B&&B[t]?B[t]:"",r,i;if(n&&e&&e.length)for(r=0,i=e.length;r<i;r++)n=n.replace("%s",e[r]);return n},it=function(e){return m===8&&e.loops>1&&e.stream&&(N("as2loop"),e.stream=!1),e},st=function(e,t){return e&&!e.usePolicyFile&&(e.onid3||e.usePeakData||e.useWaveformData||e.useEQData)&&(i._wD((t||"")+Z("policy")),e.usePolicyFile=!0),e},ot=function(e){typeof console!="undefined"&&typeof console.warn!="undefined"?console.warn(e):i._wD(e)},d=function(){return!1},J=function(e){var t;for(t in e)e.hasOwnProperty(t)&&typeof e[t]=="function"&&(e[t]=d);t=null},K=function(e){typeof e=="undefined"&&(e=!1);if(x||e)N("smFail",2),i.disable(e)},Q=function(e){var t=null,n;if(e)if(e.match(/\.swf(\?.*)?$/i)){t=e.substr(e.toLowerCase().lastIndexOf(".swf?")+4);if(t)return e}else e.lastIndexOf("/")!==e.length-1&&(e+="/");return n=(e&&e.lastIndexOf("/")!==-1?e.substr(0,e.lastIndexOf("/")+1):"./")+i.movieURL,i.noSWFCache&&(n+="?ts="+(new Date).getTime()),n},P=function(){m=parseInt(i.flashVersion,10),m!==8&&m!==9&&(i._wD(Z("badFV",m,$)),i.flashVersion=m=$);var e=i.debugMode||i.debugFlash?"_debug.swf":".swf";i.useHTML5Audio&&!i.html5Only&&i.audioFormats.mp4.required&&m<9&&(i._wD(Z("needfl9")),i.flashVersion=m=9),i.version=i.versionNumber+(i.html5Only?" (HTML5-only mode)":m===9?" (AS3/Flash 9)":" (AS2/Flash 8)"),m>8?(i.defaultOptions=L(i.defaultOptions,i.flash9Options),i.features.buffering=!0,i.defaultOptions=L(i.defaultOptions,i.movieStarOptions),i.filePatterns.flash9=new RegExp("\\.(mp3|"+Qt.join("|")+")(\\?.*)?$","i"),i.features.movieStar=!0):i.features.movieStar=!1,i.filePattern=i.filePatterns[m!==8?"flash9":"flash8"],i.movieURL=(m===8?"soundmanager2.swf":"soundmanager2_flash9.swf").replace(".swf",e),i.features.peakData=i.features.waveformData=i.features.eqData=m>8},W=function(e,t){if(!s)return!1;s._setPolling(e,t)},X=function(){i.debugURLParam.test(h)&&(i.debugMode=!0);if(f(i.debugID))return!1;var e,t,n,r,s;if(i.debugMode&&!f(i.debugID)&&(!Rt||!i.useConsole||!i.consoleOnly)){e=p.createElement("div"),e.id=i.debugID+"-toggle",r={position:"fixed",bottom:"0px",right:"0px",width:"1.2em",height:"1.2em",lineHeight:"1.2em",margin:"2px",textAlign:"center",border:"1px solid #999",cursor:"pointer",background:"#fff",color:"#333",zIndex:10001},e.appendChild(p.createTextNode("-")),e.onclick=rt,e.title="Toggle SM2 debug console",l.match(/msie 6/i)&&(e.style.position="absolute",e.style.cursor="hand");for(s in r)r.hasOwnProperty(s)&&(e.style[s]=r[s]);t=p.createElement("div"),t.id=i.debugID,t.style.display=i.debugMode?"block":"none";if(i.debugMode&&!f(e.id)){try{n=R(),n.appendChild(e)}catch(o){throw new Error(Z("domError")+" \n"+o.toString())}n.appendChild(t)}}n=null},ut=this.getSoundById,N=function(e,t){return e?i._wD(Z(e),t):""},h.indexOf("sm2-debug=alert")+1&&i.debugMode&&(i._wD=function(t){e.alert(t)}),rt=function(){var e=f(i.debugID),t=f(i.debugID+"-toggle");if(!e)return!1;y?(t.innerHTML="+",e.style.display="none"):(t.innerHTML="-",e.style.display="block"),y=!y},b=function(e,t,n){if(typeof sm2Debugger!="undefined")try{sm2Debugger.handleEvent(e,t,n)}catch(r){}return!0},tt=function(){var e=[];return i.debugMode&&e.push(nt.sm2Debug),i.debugFlash&&e.push(nt.flashDebug),i.useHighPerformance&&e.push(nt.highPerf),e.join(" ")},et=function(){var e=Z("fbHandler"),t=i.getMoviePercent(),n=nt,r={type:"FLASHBLOCK"};if(i.html5Only)return!1;i.ok()?(i.didFlashBlock&&i._wD(e+": Unblocked"),i.oMC&&(i.oMC.className=[tt(),n.swfDefault,n.swfLoaded+(i.didFlashBlock?" "+n.swfUnblocked:"")].join(" "))):(mt&&(i.oMC.className=tt()+" "+n.swfDefault+" "+(t===null?n.swfTimedout:n.swfError),i._wD(e+": "+Z("fbTimeout")+(t?" ("+Z("fbLoaded")+")":""))),i.didFlashBlock=!0,O({type:"ontimeout",ignoreInit:!0,error:r}),z(r))},A=function(e,t,n){typeof g[e]=="undefined"&&(g[e]=[]),g[e].push({method:t,scope:n||null,fired:!1})},O=function(e){e||(e={type:"onready"});if(!S&&e&&!e.ignoreInit)return!1;if(e.type==="ontimeout"&&i.ok())return!1;var t={success:e&&e.ignoreInit?i.ok():!x},n=e&&e.type?g[e.type]||[]:[],r=[],s,u,a=[t],f=mt&&i.useFlashBlock&&!i.ok();e.error&&(a[0].error=e.error);for(s=0,u=n.length;s<u;s++)n[s].fired!==!0&&r.push(n[s]);if(r.length){i._wD(o+": Firing "+r.length+" "+e.type+"() item"+(r.length===1?"":"s"));for(s=0,u=r.length;s<u;s++)r[s].scope?r[s].method.apply(r[s].scope,a):r[s].method.apply(this,a),f||(r[s].fired=!0)}return!0},M=function(){c.setTimeout(function(){i.useFlashBlock&&et(),O(),i.onload instanceof Function&&(N("onload",1),i.onload.apply(c),N("onloadOK",1)),i.waitForWindowLoad&&Tt.add(c,"load",M)},1)},Lt=function(){if(kt!==undefined)return kt;var e=!1,t=navigator,n=t.plugins,r,i,s,o=c.ActiveXObject;if(n&&n.length)i="application/x-shockwave-flash",s=t.mimeTypes,s&&s[i]&&s[i].enabledPlugin&&s[i].enabledPlugin.description&&(e=!0);else if(typeof o!="undefined"){try{r=new o("ShockwaveFlash.ShockwaveFlash")}catch(u){}e=!!r}return kt=e,e},gt=function(){var e,t,n=_t&&!!l.match(/os (1|2|3_0|3_1)/i);if(n)return i.hasHTML5=!1,i.html5Only=!0,i.oMC&&(i.oMC.style.display="none"),!1;if(!i.useHTML5Audio)return!0;if(!i.html5||!i.html5.canPlayType)return i._wD("SoundManager: No HTML5 Audio() support detected."),i.hasHTML5=!1,!0;i.hasHTML5=!0;if(qt){i._wD(u+"Note: Buggy HTML5 Audio in Safari on this OS X release, see https://bugs.webkit.org/show_bug.cgi?id=32159 - "+(kt?"will use flash fallback for MP3/MP4, if available":" would use flash fallback for MP3/MP4, but none detected."),1);if(Lt())return!0}for(t in i.audioFormats)i.audioFormats.hasOwnProperty(t)&&(i.audioFormats[t].required&&!i.html5.canPlayType(i.audioFormats[t].type)||i.flash[t]||i.flash[i.audioFormats[t].type])&&(e=!0);return i.ignoreFlash&&(e=!1),i.html5Only=i.hasHTML5&&i.useHTML5Audio&&!e,!i.html5Only},vt=function(e){var t,n,r=0;if(e instanceof Array){for(t=0,n=e.length;t<n;t++)if(e[t]instanceof Object){if(i.canPlayMIME(e[t].type)){r=t;break}}else if(i.canPlayURL(e[t])){r=t;break}return e[r].url&&(e[r]=e[r].url),e[r]}return e},lt=function(t){t._hasTimer||(t._hasTimer=!0,!It&&i.html5PollingInterval&&(dt===null&&pt===0&&(dt=e.setInterval(ht,i.html5PollingInterval)),pt++))},ct=function(e){e._hasTimer&&(e._hasTimer=!1,!It&&i.html5PollingInterval&&pt--)},ht=function(){var t;if(dt!==null&&!pt)return e.clearInterval(dt),dt=null,!1;for(t=i.soundIDs.length-1;t>=0;t--)i.sounds[i.soundIDs[t]].isHTML5&&i.sounds[i.soundIDs[t]]._hasTimer&&i.sounds[i.soundIDs[t]]._onTimer()},z=function(e){e=typeof e!="undefined"?e:{},i.onerror instanceof Function&&i.onerror.apply(c,[{type:typeof e.type!="undefined"?e.type:null}]),typeof e.fatal!="undefined"&&e.fatal&&i.disable()},At=function(){if(!qt||!Lt())return!1;var e=i.audioFormats,t,n;for(n in e)if(e.hasOwnProperty(n))if(n==="mp3"||n==="mp4"){i._wD(o+": Using flash fallback for "+n+" format"),i.html5[n]=!1;if(e[n]&&e[n].related)for(t=e[n].related.length-1;t>=0;t--)i.html5[e[n].related[t]]=!1}},this._setSandboxType=function(e){var t=i.sandbox;t.type=e,t.description=t.types[typeof t.types[e]!="undefined"?e:"unknown"],i._wD("Flash security sandbox type: "+t.type),t.type==="localWithFile"?(t.noRemote=!0,t.noLocal=!1,N("secNote",2)):t.type==="localWithNetwork"?(t.noRemote=!1,t.noLocal=!0):t.type==="localTrusted"&&(t.noRemote=!1,t.noLocal=!1)},this._externalInterfaceOK=function(e,t){if(i.swfLoaded)return!1;var n,r=(new Date).getTime();i._wD(u+"externalInterfaceOK()"+(e?" (~"+(r-e)+" ms)":"")),b("swf",!0),b("flashtojs",!0),i.swfLoaded=!0,zt=!1,qt&&At();if(!t||t.replace(/\+dev/i,"")!==i.versionNumber.replace(/\+dev/i,""))return n=o+': Fatal: JavaScript file build "'+i.versionNumber+'" does not match Flash SWF build "'+t+'" at '+i.url+". Ensure both are up-to-date.",setTimeout(function(){throw new Error(n)},0),!1;Ht?setTimeout(v,100):v()},U=function(e,t){function n(){i._wD("-- SoundManager 2 "+i.version+(!i.html5Only&&i.useHTML5Audio?i.hasHTML5?" + HTML5 audio":", no HTML5 audio support":"")+(i.html5Only?"":(i.useHighPerformance?", high performance mode, ":", ")+((i.flashPollingInterval?"custom ("+i.flashPollingInterval+"ms)":"normal")+" polling")+(i.wmode?", wmode: "+i.wmode:"")+(i.debugFlash?", flash debug mode":"")+(i.useFlashBlock?", flashBlock mode":""))+" --",1)}function L(e,t){return'<param name="'+e+'" value="'+t+'" />'}if(w&&E)return!1;if(i.html5Only)return P(),n(),i.oMC=f(i.movieID),v(),w=!0,E=!0,!1;var r=t||i.url,s=i.altURL||r,o="JS/Flash audio component (SoundManager 2)",a,c,h=R(),d,m,g,y=tt(),b,S,x,T=null,C=null,k=p.getElementsByTagName("html")[0];C=k&&k.dir&&k.dir.match(/rtl/i),e=typeof e=="undefined"?i.id:e,P(),i.url=Q($t?r:s),t=i.url,i.wmode=!i.wmode&&i.useHighPerformance?"transparent":i.wmode,i.wmode!==null&&(l.match(/msie 8/i)||!Ht&&!i.useHighPerformance)&&navigator.platform.match(/win32|win64/i)&&(N("spcWmode"),i.wmode=null),a={name:e,id:e,src:t,quality:"high",allowScriptAccess:i.allowScriptAccess,bgcolor:i.bgColor,pluginspage:Jt+"www.macromedia.com/go/getflashplayer",title:o,type:"application/x-shockwave-flash",wmode:i.wmode,hasPriority:"true"},T!==null&&(a.width=T,a.height=T),i.debugFlash&&(a.FlashVars="debug=1"),i.wmode||delete a.wmode;if(Ht)c=p.createElement("div"),m=['<object id="'+e+'" data="'+t+'" type="'+a.type+'" title="'+a.title+'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="'+Jt+'download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0" width="'+a.width+'" height="'+a.height+'">',L("movie",t),L("AllowScriptAccess",i.allowScriptAccess),L("quality",a.quality),i.wmode?L("wmode",i.wmode):"",L("bgcolor",i.bgColor),L("hasPriority","true"),i.debugFlash?L("FlashVars",a.FlashVars):"","</object>"].join("");else{c=p.createElement("embed");for(d in a)a.hasOwnProperty(d)&&c.setAttribute(d,a[d])}X(),y=tt(),h=R();if(h){i.oMC=f(i.movieID)||p.createElement("div");if(!i.oMC.id){i.oMC.id=i.movieID,i.oMC.className=nt.swfDefault+" "+y,b=null,g=null,i.useFlashBlock||(i.useHighPerformance?b={position:"fixed",width:"8px",height:"8px",bottom:"0px",left:"0px",overflow:"hidden"}:(b={position:"absolute",width:"6px",height:"6px",top:"-9999px",left:"-9999px"},C&&(b.left=Math.abs(parseInt(b.left,10))+"px"))),Bt&&(i.oMC.style.zIndex=1e4);if(!i.debugFlash)for(S in b)b.hasOwnProperty(S)&&(i.oMC.style[S]=b[S]);try{Ht||i.oMC.appendChild(c),h.appendChild(i.oMC),Ht&&(g=i.oMC.appendChild(p.createElement("div")),g.className=nt.swfBox,g.innerHTML=m),E=!0}catch(A){throw new Error(Z("domError")+" \n"+A.toString())}}else x=i.oMC.className,i.oMC.className=(x?x+" ":nt.swfDefault)+(y?" "+y:""),i.oMC.appendChild(c),Ht&&(g=i.oMC.appendChild(p.createElement("div")),g.className=nt.swfBox,g.innerHTML=m),E=!0}return w=!0,n(),i._wD(u+"createMovie(): Trying to load "+t+(!$t&&i.altURL?" (alternate URL)":""),1),!0},j=function(){return i.html5Only?(U(),!1):s?!1:(s=i.getMovie(i.id),s||(G?(Ht?i.oMC.innerHTML=Y:i.oMC.appendChild(G),G=null,w=!0):U(i.id,i.url),s=i.getMovie(i.id)),s&&N("waitEI"),i.oninitmovie instanceof Function&&setTimeout(i.oninitmovie,1),!0)},_=function(){setTimeout(D,1e3)},D=function(){if(at)return!1;at=!0,Tt.remove(c,"load",_);if(zt&&!Ut)return N("waitFocus"),!1;var e;S||(e=i.getMoviePercent(),i._wD(Z("waitImpatient",e===100?" (SWF loaded)":e>0?" (SWF "+e+"% loaded)":""))),setTimeout(function(){e=i.getMoviePercent(),S||(i._wD(o+": No Flash response within expected time.\nLikely causes: "+(e===0?"Loading "+i.movieURL+" may have failed (and/or Flash "+m+"+ not present?), ":"")+"Flash blocked or JS-Flash security error."+(i.debugFlash?" "+Z("checkSWF"):""),2),!$t&&e&&(N("localFail",2),i.debugFlash||N("tryDebug",2)),e===0&&i._wD(Z("swf404",i.url)),b("flashtojs",!1,": Timed out"+$t?" (Check flash security or flash blockers)":" (No plugin/missing SWF?)")),!S&&Wt&&(e===null?i.useFlashBlock||i.flashLoadTimeout===0?(i.useFlashBlock&&et(),N("waitForever")):K(!0):i.flashLoadTimeout===0?N("waitForever"):K(!0))},i.flashLoadTimeout)},H=function(){function e(){Tt.remove(c,"focus",H),Tt.remove(c,"load",H)}return Ut||!zt?(e(),!0):(Wt=!0,Ut=!0,i._wD(u+"handleFocus()"),jt&&zt&&Tt.remove(c,"mousemove",H),at=!1,e(),!0)},Mt=function(){var e,t=[];if(i.useHTML5Audio&&i.hasHTML5){for(e in i.audioFormats)i.audioFormats.hasOwnProperty(e)&&t.push(e+": "+i.html5[e]+(!i.html5[e]&&kt&&i.flash[e]?" (using flash)":i.preferFlash&&i.flash[e]&&kt?" (preferring flash)":i.html5[e]?"":" ("+(i.audioFormats[e].required?"required, ":"")+"and no flash support)"));i._wD("-- SoundManager 2: HTML5 support tests ("+i.html5Test+"): "+t.join(", ")+" --",1)}},k=function(e){if(S)return!1;if(i.html5Only)return i._wD("-- SoundManager 2: loaded --"),S=!0,M(),b("onload",!0),!0;var t=i.useFlashBlock&&i.flashLoadTimeout&&!i.getMoviePercent(),n;return t||(S=!0,x&&(n={type:!kt&&mt?"NO_FLASH":"INIT_TIMEOUT"})),i._wD("-- SoundManager 2 "+(x?"failed to load":"loaded")+" ("+(x?"security/load error":"OK")+") --",1),x||e?(i.useFlashBlock&&i.oMC&&(i.oMC.className=tt()+" "+(i.getMoviePercent()===null?nt.swfTimedout:nt.swfError)),O({type:"ontimeout",error:n}),b("onload",!1),z(n),!1):(b("onload",!0),i.waitForWindowLoad&&!T?(N("waitOnload"),Tt.add(c,"load",M),!1):(i.waitForWindowLoad&&T&&N("docLoaded"),M(),!0))},v=function(){function e(){Tt.remove(c,"load",i.beginDelayedInit)}N("init");if(S)return N("didInit"),!1;if(i.html5Only)return S||(e(),i.enabled=!0,k()),!0;j();try{N("flashJS"),s._externalInterfaceTest(!1),W(!0,i.flashPollingInterval||(i.useHighPerformance?10:50)),i.debugMode||s._disableDebug(),i.enabled=!0,b("jstoflash",!0),i.html5Only||Tt.add(c,"unload",d)}catch(t){return i._wD("js/flash exception: "+t.toString()),b("jstoflash",!1),z({type:"JS_TO_FLASH_EXCEPTION",fatal:!0}),K(!0),k(),!1}return k(),e(),!0},F=function(){return q?!1:(q=!0,X(),function(){var e="sm2-usehtml5audio=",t=h.toLowerCase(),n=null,r="sm2-preferflash=",s=null,o=typeof console!="undefined"&&typeof console.log!="undefined";t.indexOf(e)!==-1&&(n=t.charAt(t.indexOf(e)+e.length)==="1",o&&console.log((n?"Enabling ":"Disabling ")+"useHTML5Audio via URL parameter"),i.useHTML5Audio=n),t.indexOf(r)!==-1&&(s=t.charAt(t.indexOf(r)+r.length)==="1",o&&console.log((s?"Enabling ":"Disabling ")+"preferFlash via URL parameter"),i.preferFlash=s)}(),!kt&&i.hasHTML5&&(i._wD("SoundManager: No Flash detected"+(i.useHTML5Audio?". Trying HTML5-only mode.":", enabling HTML5.")),i.useHTML5Audio=!0,i.preferFlash=!1),xt(),i.html5.usingFlash=gt(),mt=i.html5.usingFlash,Mt(),!kt&&mt&&(i._wD("SoundManager: Fatal error: Flash is needed to play some required formats, but is not available."),i.flashLoadTimeout=1),p.removeEventListener&&p.removeEventListener("DOMContentLoaded",F,!1),j(),!0)},St=function(){return p.readyState==="complete"&&(F(),p.detachEvent("onreadystatechange",St)),!0},I=function(){T=!0,Tt.remove(c,"load",I)},Lt(),Tt.add(c,"focus",H),Tt.add(c,"load",H),Tt.add(c,"load",_),Tt.add(c,"load",I),jt&&zt&&Tt.add(c,"mousemove",H),p.addEventListener?p.addEventListener("DOMContentLoaded",F,!1):p.attachEvent?p.attachEvent("onreadystatechange",St):(b("onload",!1),z({type:"NO_DOM2_EVENTS",fatal:!0})),p.readyState==="complete"&&setTimeout(F,100)}var t=null;if(typeof SM2_DEFER=="undefined"||!SM2_DEFER)t=new n("/tibbr/images/swf/");e.SoundManager=n,e.soundManager=t})(window)}),define("modules/chat",["jquery","underscore","backbone","tibbr","modules/dialog","require/strophe","require/sound-manager"],function(e,t,n,r,i,s,o){var u=function(e){this.options=e;var n=r.appConfig("chat");this.url=r.appConfig("chat","url"),n.multi_domain&&(n.multi_domain_url?this.url=n.multi_domain_url.replace("%{number}%",t.random(1,1e3)):this.url=r.appConfig("site","config","site_root").replace(/https?:\/\//,"https://xmpp-"+t.random(1,1e3)+".").replace(/\/tibbr\/?$/,n.url)),this.historyUrl=r.path("/chat/history"),this.connectUrl=r.path("/chat/connect"),this.jid=r.currentUser.jid(),this.on("connected",this.connected,this),this.on("disconnected",this.disconnected,this),this.on("play:sound",this.playSound,this),t.bindAll(this,"winBlur","blinkTitle","winFocus"),this.initSound()};return t.extend(u.prototype,n.Events,{cookie:new r.cookie("_c",{path:"/",secure:r.appConfig("ssl","enable")}),strophe:s.strophe,$build:s.build,$msg:s.msg,$iq:s.iq,$pres:s.pres,waitTime:60,holdTime:1,sound:null,titleTimer:null,winActive:!0,ieActive:document.activeElement,reconnected:!1,isConnected:function(){return this.connection!=null&&this.connection.connected},hasCredential:function(){var e=this._sid,t=this._rid;return e!==undefined&&e!==null&&t!==undefined&&t!==null},hasError:function(t,n){if(n)return;return t.sid===null&&t.rid===null&&t.jid===null&&e(t.chat_server_response).find("error").find("text").text()==="Resource already exists"?(i.alert({text:r.translate("chat.error.message"),title:r.translate("chat.error.title")}),!0):!1},time:function(){return(new Date).format("h:i a")},blinkTitle:function(){this.titleTimer&&clearInterval(this.titleTimer);var e=this;this.titleTimer=setInterval(function(){document.title=document.title===r.translate("chat.new_message")?r.pageTitle:r.translate("chat.new_message")},1e3)},winBlur:function(){return this.ieActive!==document.activeElement?(this.ieActive=document.activeElement,!0):(this.winActive=!1,!0)},winFocus:function(){return this.winActive=!0,clearInterval(this.titleTimer),document.title=r.pageTitle,!0},start:function(e){this.hasCredential()?this.attach():this.connect(e)},connectWithToken:function(e){var t="<auth-token>"+r.$.cookie("_TOKEN")+"</auth-token><client-key>Key</client-key>",n=this,i=new this.strophe.Connection(this.url);i.connect(this.jid,t,function(e){console.log(e,n.strophe.Status),e===n.strophe.Status.CONNECTED?n.trigger("connected"):e===n.strophe.Status.DISCONNECTED&&n.trigger("disconnected")},this.waitTime,this.holdTime),this.connection=i},connect:function(t){if(this.isConnected())return;var n=this,r=e("#chat-list-wrap > h4");e.ajax({url:n.connectUrl,dataType:"json",type:"POST",beforeSend:function(){e("#chat-list").hide(),r.append(spinner)},success:function(e){n.hasError(e,t)||(n._sid=e.sid,n._rid=e.rid,n.hasCredential()?n.attach():console.warn("enable to connect to chat"))},complete:function(){r.find(".spinner").remove()}})},connected:function(){this.cookie.set("connected",1);var e=this.$iq({to:this.strophe.getDomainFromJid(this.jid),type:"get",id:"disco-1"}).c("query",{xmlns:this.strophe.NS.DISCO_INFO});this.connection.sendIQ(e,null,null),this.connection.addHandler(this.options.onMessage,null,"message","chat"),this.connection.addHandler(this.options.onPresence,null,"presence"),this.trigger("chat:connected")},sendPresence:function(){this.connection&&this.connection.send(this.$pres())},disconnected:function(){this.cookie.empty(),this.connection=null,this._sid=this._rid=null,this.trigger("chat:disconnected")},disconnect:function(){this.connection.disconnect(),this.disconnected()},attach:function(){if(this.isConnected())return;if(!this.hasCredential()){this.trigger("disconnected");return}var e=this,t=new this.strophe.Connection(this.url);t.attach(this.jid,this._sid,this._rid,function(t){(t===e.strophe.Status.DISCONNECTED||t===e.strophe.Status.DISCONNECTING)&&e.trigger("disconnected")},this.waitTime,this.holdTime),t.authenticated?(this.connection=t,this.trigger("connected")):this.trigger("disconnected"),this.connection=t},playSound:function(){this.winActive||this.blinkTitle();if(r.pCookie.get("sound")===1)try{r.chatSound.play()}catch(e){console.warn("No Support for chat sound")}},initSound:function(){var e=this;window.soundManager.url=r.path("images/swf/"),window.soundManager.useFlashBlock=!1,window.soundManager.useHighPerformance=!0,window.soundManager.wmode="transparent",window.soundManager.onload=function(){r.chatSound=window.soundManager.createSound({id:"chat",volume:30,url:r.path("images/mp3/chat.mp3"),autoLoad:!0})}}}),u}),define("text!templates/chat/stream.html",[],function(){return'{{if date != null}}\n<li class="chat-date">${date}</li> {{/if}}\n<li class="chat-message ctipsy" title="${time}">\n    <span class="chat-name" title="${name}">\n        <a class="profile-pic small" style="cursor:default">\n            <img width="24" height="24" src="${user.image}" alt="${user.get(\'name\')}">\n        </a>\n    </span>\n    <!--<span class="chat-name" title="${name}">${helper.str.truncate(name,\'20\')} : </span>-->\n    <span class="chat-text">{{html body}}</span>\n</li>'}),define("views/chat/stream",["jquery","underscore","tibbr","models/chat_user","require/moment","text!templates/chat/stream.html"],function(e,t,n,r,i,s){return n.View.extend({events:{},render:function(){var e=this.options.stream,t=e.id===n.currentUser.id?"me":"other";return e.body=this.formatText(e.body),e.time=e.time||this.time(),e.user=e.id===n.currentUser.id?n.currentUser:this.model,this.$el.html(this.template.render(s,e)).find(".chat-name").addClass(t),t=="me"?this.$el.find(".chat-name").closest(".chat-message").addClass("other-chat"):t=="other"&&this.$el.find(".chat-name").closest(".chat-message").addClass("my-chat"),this.$(".ctipsy").qtip(n.qtipConfigs.tipsy({position:{at:"right center",my:"center left"}})),this},time:function(){return i().format(n.dateFormat.hhh)},formatText:function(e){var t=/((?:ht|f)tps?:\/\/[\S|\?]+)/g,n=new RegExp("("+window.location.host+"[^s]+)","g"),r=/(www\.[\S]+(\b|$))/g,i=/<a.+href.+>.+<\/a>.*/g;return e=e.replace(t,function(e){var t=e.match(n)?"":'target="_blank"';return'<a href="'+e+'" '+t+" >"+e+"</a>"}),e.match(i)||(e=e.replace(r,function(e){var t=e.match(n)?"":'target="_blank"';return'<a href="http://'+e+'" target="_blank">'+e+"</a>"})),e.replace(/\n\r?/g,"<br />")}})}),define("text!templates/chat/window.html",[],function(){return'<div class="chat-window ${model.get(\'status\')}" id="chat-window-${model.id}">\n    <p class="cw-header" style="margin:0">\n        <img class="ci status ${model.get(\'status\')}" alt="" src="${context}images/cleardot.png"/><span class="name" title="${model.get(\'name\')}">${helper.str.truncate(model.get(\'name\'),20)}</span>\n        <a class="icon-hover"><img class="ci close" alt="" src="${context}images/cleardot.png"/></a>\n        <a class="icon-hover"><img class="ci collapsible open" alt="" src="${context}images/cleardot.png"/></a>\n    </p>\n\n    <div class="chat-conversation-wrapper">\n        <div class="chat-conversation" id="x">\n            <ul class="chat-stream"></ul>\n            <ul class="offline-notice">\n                <li>{{=  t(\'chat.offlineMessage\', {name: model.get(\'name\')}) }}</li>\n            </ul>\n        </div>\n        <div class="chat-input-wrap">\n            <textarea class="chat-input"></textarea>\n        </div>\n    </div>\n</div>\n'}),define("views/chat/window",["jquery","underscore","tibbr","models/chat_user","views/chat/stream","text!templates/chat/window.html"],function(e,t,n,r,i,s){return n.View.extend({className:"wrap wap-chat-window",initialize:function(){this.model.on("change:status",this.changeStatus,this),this.parent=this.options.parent,this.chat=this.parent.chat,this.bindTo(this.parent,"new:message",this.message,this)},typingTimer:null,events:{"click img.ci.close":"close","click p.cw-header":"collapsible","keypress .chat-input":"sendMessage","click .chat-input":"removeActive","keyup .chat-input":"typing",mouseover:function(){if(n.Helper.OSName()==="windows")return;e(document).trigger("scroll:stop")},mouseout:function(){if(n.Helper.OSName()==="windows")return;e(document).trigger("scroll:resume")}},render:function(){return this.$el.html(this.template.render(s,{model:this.model,context:n.context()})),this.getHistory(),this},changeStatus:function(){this.$(".chat-window").removeClass("online").removeClass("offline").addClass(this.model.get("status")),this.$(".status").removeClass("online").removeClass("offline").addClass(this.model.get("status")),this.show()},show:function(){var e=this.$el;return e.show().find(".chat-window").show(),this.model.get("status")==="online"?e.find(".offline-notice").hide():e.find(".offline-notice").show(),e.find(".chat-input").focus(),this.parent.trigger("window:change",{id:this.model.id,state:1}),this},scroll:function(){var e=this.$(".chat-stream").get(0);return e.scrollTop=e.scrollHeight,this},resize:function(){var t=e(window).height();return this.$el.css("height",t),this},close:function(){this.remove(),this.parent.trigger("window:close",this.model.id),this.trigger("removed")},collapsible:function(t){if(t!==undefined&&e(t.target).hasClass("close"))return;var n=this.$(".chat-conversation-wrapper");n.is(":visible")?(n.hide().end().children(".collapsible").addClass("hidden"),this.open=!1):(n.show().end().children(".collapsible").removeClass("hidden"),this.open=!0),this.parent.trigger("window:change",{id:this.model.id,state:this.open?1:0})},minimize:function(){this.$(".chat-conversation-wrapper").hide().end().children(".collapsible").addClass("hidden"),this.open=!1},makeKey:function(e){var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var r=0;r<20;r++)t+=n.charAt(Math.floor(Math.random()*n.length));return e+t},threadId:function(){var e=this.model.id,t="t"+e,n=this.chat.cookie.get(t);n?this.threadID=n:(n=this.makeKey(e),this.threadID=n,this.chat.cookie.set(t,n))},setThreadId:function(e){var t="t"+this.model.id,n=this.chat.cookie.get(t);if(n===null)this.chat.cookie.set(t,e);else{var r=this.$(".chat-input");this.threadID!==e&&(this.threadID=e,this.chat.cookie.set(t,e))}},scrollChat:function(){var e=this.$(".chat-stream").get(0);e.scrollTop=e.scrollHeight},removeActive:function(){this.$(".chat-window").removeClass("active")},sendMessage:function(e){if(!this.chat.isConnected()){this.chat.trigger("disconnected");return}this.threadId();var t=n.currentUser,r=this.model.jid(),s=this.$(".chat-input"),o=this.threadID,u=s.val();if(!e.shiftKey||e.which!==13)if(e.which===13){if(u.length<1)return s.val(""),!1;e.preventDefault();var a=this.chat.$msg({to:r,type:"chat"}).c("body").t(u).up().c("thread").t(o).up().c("id").t(t.id+"").up().c("name").t(t.get("display_name")).up().c("image").t(t.get("profileImage")).up().c("active",{xmlns:"http://jabber.org/protocol/chatstates"});this.chat.connection.send(a);var f=this.today?null:this.t("chat.today");this.$("ul.chat-stream").append(this.initChild(i,{model:this.model,stream:{id:t.id,name:t.get("display_name"),body:u,date:f}}).render().el),this.today=!0,this.scrollChat(),s.val(""),this.composing=!1}else{var l=this.composing,c=0,h=s.val().length;if(!l&&h>1&&h!==c){c=h;var p=this.chat.$msg({to:r,type:"chat"}).c("thread").t(o).up().c("id").t(t.id+"").up().c("name").t(t.get("display_name")).up().c("image").t(t.get("profileImage")).up().c("composing",{xmlns:"http://jabber.org/protocol/chatstates"});this.chat.connection.send(p),this.composing=!0}}},typing:function(e){if(!this.chat.isConnected()){this.chat.trigger("disconnected");return}this.threadId();var t=this,r=this.threadID,i=n.currentUser;if(e.which===13)return;this.typingTimer&&window.clearTimeout(this.typingTimer),this.typingTimer=window.setTimeout(function(){var e=t.chat.$msg({to:t.model.jid(),type:"chat"}).c("thread").t(r).up().c("id").t(i.id+"").up().c("name").t(i.get("display_name")).up().c("image").t(i.get("profileImage")).up().c("inactive",{xmlns:"http://jabber.org/protocol/chatstates"});t.chat.connection.send(e),t.composing=!1},1e3)},message:function(t){if(!this.chat.isConnected()){this.chat.trigger("disconnected");return}console.log(parseInt(t.find("id").text()),this.model.id);if(parseInt(t.find("id").text())!==this.model.id)return;var n=t.attr("from"),r=this.chat.strophe.getBareJidFromJid(n),s=t.find("thread").text(),o=t.find("id").text(),u=t.find("image").text(),a=t.find("name").text(),f=t.find("html > body"),l=t.find("composing"),c=t.find("inactive");if(c.length>0)this.$(".chat-status").remove();else if(l.length>0)return this.$(".chat-status").remove(),this.$(".cflash-msg").append('<span class="chat-status">'+this.t("chat.typing")+"</span>"),!0;if(f.length===0)f=t.find("body"),f.length>0?f=f.text():f=null;else{f=f.contents();var h=e("<span></span>");f.each(function(){document.importNode?e(document.importNode(this,!0)).appendTo(h):h.append(this.xml)}),f=h}if(f){this.setThreadId(s),this.$(".chat-window").addClass("active").find(".chat-status").remove();var p=this.$("ul.chat-stream"),d=this.today?null:this.t("chat.today");this.$("ul.chat-stream").append(this.initChild(i,{model:this.model,stream:{id:o,name:a,body:f,date:d}}).render().el),this.today=!0,this.scrollChat(),this.chat.playSound()}return!0},getHistory:function(){var r=this.$(".chat-stream"),s=this;if(r.find("li").length>0||r.find(".spinner").length>0)return;e.ajax({url:this.chat.historyUrl,data:{u:this.model.id,h:this.threadID},dataType:"json",type:"POST",beforeSend:function(){r.prepend(spinner)},complete:function(){r.find(".spinner").remove()},success:function(e){t.each(e.messages.reverse(),function(e){var t=e.u===n.currentUser.id?n.currentUser.get("display_name"):s.model.get("name");r.prepend(s.initChild(i,{model:s.model,stream:{id:e.u,name:t,body:e.m,date:e.d,time:e.t}}).render().el)}),s.today=e.today,s.scrollChat()}})},onLeave:function(){if(n.Helper.OSName()==="windows")return;e(document).trigger("scroll:resume")}})}),define("text!templates/chat/contact.html",[],function(){return'<a class="profile-pic small">\n    <img src="${model.image}" alt="${model.get(\'name\')}"  height="24" width="24"/>\n</a>\n<div class="info">\n    <p>\n        <img src="${context}images/cleardot.png" class="ci status"  alt=""/>\n        <span class="roster-name">${model.get(\'name\')}</span> ${chat_link}\n    </p>\n</div>\n'}),define("views/chat/contact_item",["jquery","underscore","tibbr","models/chat_user","views/chat/window","text!templates/chat/contact.html"],function(e,t,n,r,i,s){return n.View.extend({tagName:"li",$wrap:e("#chat-wrap"),className:"roster-contact",initialize:function(){this.bindTo(this.model,"change",this.render,this),this.parent=this.options.parent},events:{click:"showWindow"},render:function(){return this.$el.html(this.template.render(s,{model:this.model,context:n.context()})).removeClass("online offline").addClass(this.model.get("status")).addClass("contact-"+this.model.id),this},showWindow:function(){if(e("#chat-window-"+this.model.id).length>0)return this.model.window;var t=this;return this.model.window||(this.model.hasWindow=!0,this.model.window=this.initChild(i,{model:this.model,parent:this.parent}),this.$wrap.append(this.model.window.render().el),this.model.window.on("removed",function(){t.model.window.leave(),t.model.window=null,t.model.hasWindow=!1})),this.model.window.show().resize(),this.model.window},onLeave:function(){this.model.window&&this.model.window.leave()}})}),define("views/chat/contacts",["jquery","underscore","tibbr","views/chat/contact_item"],function(e,t,n,r){return n.View.extend({tagName:"ul",initialize:function(){this.$el.addClass("chat-list striped")},events:{mouseover:function(){if(n.Helper.OSName()==="windows")return;e(document).trigger("scroll:stop")},mouseout:function(){if(n.Helper.OSName()==="windows")return;e(document).trigger("scroll:resume")}},render:function(){var e=this,n=this.collection.sortBy(function(e){return e.get("status")==="offline"}),i=this.$el;return t.each(n,function(t){var n=e.initChild(r,{model:t,parent:e.options.parent});i.append(n.render().el)}),this}})}),define("hbs!templates/chat/setting",["handlebars"],function(e){return e.template(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a=n.helperMissing,f=this.escapeExpression;return s+='<li><a class="js-status">',u={hash:{},data:i},s+=f((o=n.t||t&&t.t,o?o.call(t,"chat.off_line",u):a.call(t,"t","chat.off_line",u)))+'</a></li>\n<li><a class="js-sound"> ',u={hash:{},data:i},s+=f((o=n.t||t&&t.t,o?o.call(t,"chat.sounds",t&&t.sound,u):a.call(t,"t","chat.sounds",t&&t.sound,u)))+"</a></li>",s})}),define("views/chat/setting",["jquery","underscore","tibbr","hbs!templates/chat/setting"],function(e,t,n,r){return n.View.extend({tagName:"ul",className:"chat-setting-menu",initialize:function(){t.bindAll(this,"status","changeSound"),this.chat=this.options.chat,this.on("sound:change",this.render,this)},sound:"off",online:!0,events:{"click a.js-status":"status","click a.js-sound":"changeSound"},render:function(){return this.soundsStatus(),this.$el.html(this.renderTemplate(r,{sound:this.sound})),this},status:function(){return this.chat.isConnected()&&(n.pCookie.set("chat-logout",1),this.chat.disconnect()),!1},changeSound:function(){return this.setSounds(),this.trigger("sound:change"),e("img.setting.ci").qtip("hide"),!1},soundsStatus:function(){var e=n.pCookie.get("sound");this.sound=e===undefined||e===0?"on":"off"},setSounds:function(){var e="sound";this.sound==="on"?n.pCookie.set(e,1):n.pCookie.set(e,0)}})}),define("hbs!templates/chat/container",["handlebars"],function(e){return e.template(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a,f=n.helperMissing,l=this.escapeExpression;s+='<div id="chat-list-wrap" style="display: block;">\n    <h4>\n\n        ',a={hash:{"class":"ci chat-icon offline",id:"chat"},data:i},u=(o=n.imageTag||t&&t.imageTag,o?o.call(t,"images/cleardot.png",a):f.call(t,"imageTag","images/cleardot.png",a));if(u||u===0)s+=u;s+=" <span>",a={hash:{},data:i},s+=l((o=n.t||t&&t.t,o?o.call(t,"chat.title",a):f.call(t,"t","chat.title",a)))+'  (<strong\n            class="chat-stat">0</strong>)</span>\n        <a href="#" class="icon-hover">',a={hash:{"class":"ci collapsible open hidden"},data:i},u=(o=n.imageTag||t&&t.imageTag,o?o.call(t,"images/cleardot.png",a):f.call(t,"imageTag","images/cleardot.png",a));if(u||u===0)s+=u;s+='</a> &nbsp;&nbsp;&nbsp; &nbsp;\n    </h4>\n\n    <div id="chat-list" style="display: none">\n        <div class="search-people search-box rfloat mvxl" id="global-search">\n            <fieldset>\n                <input id="c-search" type="text" class="search-string" placeholder="',a={hash:{},data:i},s+=l((o=n.t||t&&t.t,o?o.call(t,"chat.find_people",a):f.call(t,"t","chat.find_people",a)))+'" data-default-value="',a={hash:{},data:i},s+=l((o=n.t||t&&t.t,o?o.call(t,"chat.find_people",a):f.call(t,"t","chat.find_people",a)))+'" disabled="disabled"/>\n                <button type="submit" title="Search" class="search-btn"></button>\n            </fieldset>\n        </div>\n\n        <div id="settings-control">\n            ',a={hash:{"class":"setting ci",id:"chat-setting-icon"},data:i},u=(o=n.imageTag||t&&t.imageTag,o?o.call(t,"images/cleardot.png",a):f.call(t,"imageTag","images/cleardot.png",a));if(u||u===0)s+=u;return s+='\n        </div>\n        <div id="chat-header">',a={hash:{},data:i},s+=l((o=n.t||t&&t.t,o?o.call(t,"chat.following",a):f.call(t,"t","chat.following",a)))+'</div>\n        <div class="js-chat-list"></div>\n    </div>\n</div>\n\n',s})}),define("views/chat/chat",["jquery","underscore","tibbr","collections/chat_users","models/chat_user","modules/chat","views/chat/contacts","views/chat/contact_item","views/chat/setting","hbs!templates/chat/container"],function(e,t,n,r,i,s,o,u,a,f){return n.View.extend({className:"wrap",initialize:function(){t.bindAll(this,"maxHeight","online","run","onPresence","onMessage","bind","search"),this.users=new r,this.chat=new s({onPresence:this.onPresence,onMessage:this.onMessage}),this.chat.on("chat:connected",this.initList,this),this.chat.on("chat:disconnected",this.disconnected,this),this.on("status:change",this.updateCount,this),this.on("window:close",this.removeOpen,this),this.on("window:change",this.setOpen,this),this.on("status:change",this.sortList,this)},events:{"click #chat-list-wrap h4":"collapsible"},render:function(){return this.$el.html(this.renderTemplate(f)).attr("style","display:block"),this.$("input#c-search").observeField(4,this.search).simplePlaceholder(),this.$("div#settings-control").append((new a({chat:this.chat})).render().el),this.$("img.setting").qtip(n.qtipConfigs.menu(this.$el,".chat-setting-menu",{my:"top right",at:"bottom right",tip:!1})),this},online:function(){return this.$("img#chat").removeClass("offline").addClass("online"),this.$("input#c-search").removeAttr("disabled"),this.$("#chat-header").show(),this.trigger("connect"),!1},maxHeight:function(){var t=e(window).height();e("#chat-wrapper").find(".wrap").css("height",t)},updateCount:function(){var e=this.users.select(function(e){return e.get("status")==="online"}).length;this.$(".chat-stat").text(e)},run:function(){return this.chat.hasCredential()&&this.connect(),this},collapsible:function(){if(!this.chat.isConnected()){this.onClick=!0,n.pCookie.set("chat-logout",0),this.connect();return}var e=this.$("#chat-list-wrap h4");e.next().is(":visible")?e.next().hide().end().children(".collapsible").addClass("hidden"):e.next().show().end().children(".collapsible").removeClass("hidden"),this.$(".chat-setting-menu").hide().removeClass("menu-open")},initList:function(){if(this.init_user)return;this.online();var e=this;this.users.fetch({success:function(){e.setStatusFromCookie(),e.renderContact(),e.updateCount(),e.openWindowFromCookies(),e.chat.sendPresence(),e.$("#chat-list-wrap > h4").find(".spinner").remove(),e.onClick&&e.$("#chat-list-wrap > h4").click()},beforeSend:function(){e.$(".js-chat-list").html(n.UI.loader)},complete:function(){e.$(".js-chat-list").find(".line-loader").remove()}}),this.init_user=!0},connect:function(e){return this.chat.isConnected()||n.pCookie.get("chat-logout")===1?this:(this.chat.start(e),n.pCookie.set("chat-logout",0),this)},disconnect:function(e){e=t.isUndefined(e)?!0:e,this.chat.isConnected()&&(e&&n.pCookie.set("chat-logout",1),this.chat.disconnect())},onPresence:function(t){return this.setStatus(e(t)),!0},jidToLogin:function(e){return e.split("@")[0]},onMessage:function(t){var r=e(t),s=r.find("id"),o=this;if(s.length===0){var u=this.jidToLogin(r.attr("from")),a=this.userByLogin(u);a?(t.appendChild(n.Modules.Util._XMLDoc().createElement("id")).appendChild(n.Modules.Util._XMLDoc().createTextNode(a.id)),o._onMessage(e(t))):(new i).action("find_by_login","read",{data:{params:{login:u}},success:function(r){t.appendChild(n.Modules.Util._XMLDoc().createElement("id")).appendChild(n.Modules.Util._XMLDoc().createTextNode(r.id)),o._onMessage(e(t))}})}else this._onMessage(r);return!0},_onMessage:function(t){var n=this.userInList(t.find("id").text()),r=t.find("composing").length>0,i=t.find("inactive").length>0;if((r||i)&&(n===undefined||n&&!n.hasWindow))return!0;if(n===undefined)console.log(" !!!--- I DON'T KNOW YOU ----!!!"),n=this.buildUserFromXml(t),this.users.addOrIgnore(n),this.initChild(u,{model:n,parent:this}).showWindow();else if(n&&!n.hasWindow){var s=this.$(".contact-"+n.id);s.length>0?s.click():this.initChild(u,{model:n,parent:this}).showWindow()}return e("#chat-window-"+n.id).show(),this.trigger("new:message",t),!0},renderContact:function(e){e=e||this.users,this.$("#chat-header").show(),this.$(".js-chat-list").append(this.initChild(o,{collection:e,parent:this,className:"followers"}).render().el),this.sortList("online")},sortWithFullName:function(t,n){return e(t).find(".roster-name").text().toUpperCase()>e(n).find(".roster-name").text().toUpperCase()?1:-1},sortList:t.throttle(function(e){var t=this.$("ul.chat-list.followers");e==="online"?t.find("li.online").sort(this.sortWithFullName).prependTo(t):t.find("li.offline").sort(this.sortWithFullName).appendTo(t)},100),userInList:function(e){return this.users.detect(function(t){return t.id===parseInt(e)})},userByLogin:function(e){return this.users.detect(function(t){return t.get("login")===e})},setStatus:function(e){var t=e.attr("type")==="unavailable"?"offline":"online",n=e.attr("from").split("/")[0],r=this.users.where({jid:n})[0];r&&r.get("status")!==t&&(r.set("status",t),this.trigger("status:change",t)),r&&this.cacheStatus(e.attr("from"),r)},openWindowFromCookies:function(){var e=this;t.each(this.opens(),function(t){var n=e.users.detect(function(e){return e.id===t.i});n&&!n.hasWindow&&(e.$(".contact-"+n.id).click(),t.s===0&&n.window.minimize(),n.window.getHistory())})},buildUserFromXml:function(e){var t=e.attr("from"),n={login:t.split("@")[0],id:parseInt(e.find("id").text()),image:e.find("image").text().replace(/^\/a/,""),name:e.find("name").text()};return new i(n)},bind:function(){return this.chat.isConnected()&&this.chat.cookie.set("rid",this.chat.connection.rid),this},presence:function(){return JSON.parse(this.chat.cookie.get("presence")||"{}")},cacheStatus:function(e,n){var r=this.presence(),i="p-"+n.id,s=info[1].split("/")[1],o=r[i];"online"===n.get("status")?o?(o.push(s),r[i]=t.unique(o)):r[i]=[s]:o&&(r[i]=t.without(r[i],s),r[i].length===0&&delete r[i]),this.chat.cookie.set("presence",JSON.stringify(r))},setStatusFromCookie:function(e){if(this.chat.connection===null)return;var t=this.presence();e?t[e.id]&&e.set("status","online"):this.users.each(function(e){t[e.id]&&e.set("status","online")}),this.updateCount()},opens:function(){var e=this.chat.cookie.get("open")||"[]";return JSON.parse(e)},opened:function(e){return t.detect(this.opens(),function(t){return t.i===e})},setOpen:function(e){var n=this.opened(e.id)||{i:e.id},r=this.opens();n.s=e.state,r=t.reject(r,function(t){return t.i===e.id}),r.push(n),this.chat.cookie.set("open",JSON.stringify(r))},removeOpen:function(e){var n=this.opens();n=t.reject(n,function(t){return t.i===e}),this.chat.cookie.set("open",JSON.stringify(n))},disconnected:function(){if(this.init_user===!1)return;e("div#chat-wrapper").find(".spinner").remove(),e("div.wap-chat-window").remove(),this.leaveChild(),this.$("#chat-list").hide(),this.$("#chat-header").hide(),this.$("#chat").removeClass("online").addClass("offline"),this.$("input#c-search").attr("disabled","disabled"),this.$("#chat-list-wrap").find(".collapsible").addClass("hidden"),this.$(".chat-stat").text(0),this.$(".setting").qtip("hide"),this.init_user=!1},search:function(){var e=this.$("input#c-search"),t=e.data("default-value"),n=e.val(),i=this;if(this._searching)return;if(t==n)return;this.$("ul.chat-list.errors, ul.search-list").remove(),n.length>0?(new r).fetch({data:{q:n,page:1},beforeSend:function(){i._searching=!0},success:function(e,t){i._searching=!1;if(e.length>0){var r=i.initChild(o,{collection:e,parent:i,className:"search-list striped"});i.$(".chat-list").before(r.render().el)}else i.$(".chat-list").before("<ul class='chat-list errors'><li class='error'>"+i.t("common.no_found_results")+"  "+n+"</li></ul>");i.$("#chat-header, ul.followers").hide()}}):this.$("#chat-header, ul.followers").show()}})})})();